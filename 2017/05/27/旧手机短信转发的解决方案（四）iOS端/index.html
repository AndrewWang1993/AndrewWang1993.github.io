
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="AndrewWang&#39;s Blog">
    <title>旧手机短信转发的解决方案（四）iOS端 - AndrewWang&#39;s Blog</title>
    <meta name="author" content="AndrewWang">
    
        <meta name="keywords" content="hexo,javascript,android,java,JS,Python,">
    
    
        <link rel="icon" href="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/favicon(8).png">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"AndrewWang","sameAs":["https://github.com/AndrewWang1993","https://stackoverflow.com/users/4209302/andrewwang","mailto:fernando_caudill@outlook.com"],"image":"https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/avatar(7).png"},"articleBody":"运行在iOS系统上可查看转发短信的App\n代码结构\n\n\nPodfile(依赖的库)123456789101112source 'https://github.com/CocoaPods/Specs.git'platform :ios, ‘12.1’use_frameworks! target ‘CandySearch’ do    pod 'SwiftyJSON'    pod 'Alamofire', '~&gt; 4.4'    pod 'JPush'    pod 'CryptoSwift'    pod 'JGProgressHUD'    pod 'RainbowSwift', '~&gt; 3.0'end\nMsg.swift(消息实体类)123456789101112131415161718192021222324import Foundation// 消息类实体class Msg &#123;    var category: String  // 消息种类  SMS，Favorite    var content : String  // 消息内容    var code : String     // 消息包含的验证码    var vendor: String    // 验证码的提供商    var phone_num : String  // 发送方的手机号码    var date_time : Int    //  消息的时间戳    var is_new_msg :Bool   // 是否未打开过            init(_ category:String,_ content:String,_ code:String,         _ vendor: String,_  phone_num: String,_ date_time:Int,_ is_new_msg:Bool) &#123;        self.category=category        self.content = content        self.code = code        self.vendor = vendor        self.phone_num = phone_num        self.date_time = date_time        self.is_new_msg=is_new_msg    &#125;&#125;\nMasterViewController.swift（短信列表主界面）123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401import UIKitimport JGProgressHUDimport RainbowSwiftenum SMSCategory:String &#123;    case SMS = \"短消息\"    case FAV = \"收藏\"&#125;enum SMSOpeartion:String &#123;    case DEL = \"删除\"    case FAV = \"收藏\"&#125;let hud = JGProgressHUD(style: .dark)class MasterViewController: UITableViewController &#123;        var detailViewController: DetailViewController? = nil    var sms = [Msg]()    var filteredsms = [Msg]()    let searchController = UISearchController(searchResultsController: nil)        //拉刷新控制器    var refreshTableViewControl = UIRefreshControl()    var refreshHeaderString:String = \"下拉刷新数据\"    var latestSMSTimeStamp:Int = -1        // 界面即将加载时的回调    override func viewDidLoad() &#123;        super.viewDidLoad()        setupSearchController()                if let splitViewController = splitViewController &#123;            let controllers = splitViewController.viewControllers            detailViewController = (controllers[controllers.count - 1] as! UINavigationController).topViewController as? DetailViewController        &#125;                self.tableView.rowHeight = 55                //设置下拉刷新        self.refreshControl = UIRefreshControl()        self.refreshControl!.addTarget(self, action: #selector(getDataFromServer),for: .valueChanged)        self.refreshControl!.attributedTitle = NSAttributedString(string: refreshHeaderString)    &#125;        //视图将要出现的时候执行    override func viewWillAppear(_ animated: Bool) &#123;        clearsSelectionOnViewWillAppear = splitViewController!.isCollapsed        super.viewWillAppear(animated)        // deleteAll()        // 删除已收藏的所有内容(调试用)        refreshDataLocal()  //  新短信读取后返回消除背景色    &#125;        override func didReceiveMemoryWarning() &#123;        super.didReceiveMemoryWarning()    &#125;            // 从网络获取数据    @objc func getDataFromServer(showCirclePB:Bool=false) &#123;        // 判断是否显示进度条        if(showCirclePB)&#123;            hud.textLabel.text = \"加载中...\"            hud.show(in: self.view)            hud.dismiss(afterDelay: 8)        &#125;else&#123;            // 防止在自动加载时用户下拉刷新，造成数据重复            if(hud.isVisible)&#123;                self.refreshControl?.endRefreshing()                return;            &#125;        &#125;        self.refreshControl!.attributedTitle = NSAttributedString(string: refreshHeaderString)        fetchMsgFromServer(timestamp:latestSMSTimeStamp ,direction:\"down\",limit:100)&#123;            newMsgs,success,errorReason,statusCode in            hud.dismiss()            // 如果服务器返回正常            if(success)&#123;                var merged_sms = self.sms                for s_new in newMsgs.reversed()&#123;                    var isDupli:Bool = false                    for s_old in self.sms&#123;                        if s_new.date_time == s_old.date_time&#123;                            isDupli=true                            break                        &#125;                    &#125;                    if isDupli==false&#123;                        merged_sms=[s_new]+merged_sms                    &#125;                &#125;                self.sms=merged_sms                self.sms = self.sms.sorted(by: &#123; $0.date_time &gt; $1.date_time &#125;)                self.tableView.reloadData()                self.refreshControl?.endRefreshing()                if(!self.sms.isEmpty)&#123;                    self.latestSMSTimeStamp=self.sms[0].date_time+1  //由于服务器时间戳有小数，取整后会缺失精度，需要cell，否则会重复拉取第一条数据                    self.refreshHeaderString = \"上次刷新时间：\\(convertTimeStamp2FormatDate(timestamp: self.latestSMSTimeStamp,fomart: \"MM-dd HH:mm\"))\"                &#125;            &#125;else&#123;                self.refreshControl?.endRefreshing()                if(statusCode == 53 || statusCode==NSURLErrorNetworkConnectionLost)&#123;                    // 锁屏界面点击notify首次网络请求可能这种错误，所以忽略即可,锁屏时系统关闭网络                    print(errorReason)                    return                &#125;                let alertController = UIAlertController(title: errorReason,                                                        message: nil, preferredStyle: .alert)                //显示提示框                self.present(alertController, animated: true, completion: nil)                //两秒钟后自动消失                DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + 1) &#123;                    self.presentedViewController?.dismiss(animated: false, completion: nil)                &#125;            &#125;        &#125;    &#125;        // 重新加载本地数据并且刷新列表    func refreshDataLocal()&#123;        // 过滤出普通短信        let smsTemp = sms.filter &#123; sms in            if (sms.category == SMSCategory.SMS.rawValue)&#123;                return true            &#125;else&#123;                return false            &#125;        &#125;                // 获得收藏的短信        let favMsg = fetchMsgFromCoreData(category: SMSCategory.FAV.rawValue)        sms=smsTemp+favMsg                // 排序，将收藏的短信和原始短信放在一起        sms = sms.sorted(by: &#123; $0.date_time &gt; $1.date_time &#125;)                // 解决TAB模式下删除不能立即生效        if(searchController.isActive) &#123;            let searchBar = searchController.searchBar            let scope = searchBar.scopeButtonTitles![searchBar.selectedScopeButtonIndex]            filterContentForSearchText(\"\",scope: scope)        &#125;else&#123;            tableView.reloadData()        &#125;    &#125;        // 设置搜索头    func setupSearchController () &#123;        searchController.searchResultsUpdater = self        searchController.dimsBackgroundDuringPresentation = false        definesPresentationContext = true        tableView.tableHeaderView = searchController.searchBar        searchController.searchBar.scopeButtonTitles = [SMSCategory.SMS.rawValue, SMSCategory.FAV.rawValue]        searchController.searchBar.delegate = self    &#125;        // 设置搜索过滤和选项卡过滤    func filterContentForSearchText(_ searchText: String, scope: String = SMSCategory.SMS.rawValue) &#123;                filteredsms = sms.filter &#123; sms in            // 首先判断category是否符合            if !(sms.category == scope)&#123;                return false            &#125;                        // 然后判断短信内容是否匹配用户输入的字符            return sms.content.lowercased().contains(searchText.lowercased()) || searchText == \"\"        &#125;                tableView.reloadData()    &#125;        // TableView 子视图的数量    override func numberOfSections(in tableView: UITableView) -&gt; Int &#123;        return 1    &#125;        // 设置tableview cell 数量    override func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -&gt; Int &#123;        if searchController.isActive &#123;            return filteredsms.count        &#125;        return sms.count    &#125;        // 设置左滑可编辑    override func tableView(_ tableView: UITableView, canEditRowAt indexPath: IndexPath) -&gt; Bool &#123;        return true    &#125;        override func tableView(_ tableView: UITableView, commit editingStyle: UITableViewCellEditingStyle, forRowAt indexPath: IndexPath) &#123;        print(\"deleted at \\(indexPath)\")    &#125;            //左滑item加为收藏/删除时的回调    override func tableView(_ tableView: UITableView, editActionsForRowAt: IndexPath) -&gt; [UITableViewRowAction]? &#123;                let index = editActionsForRowAt.row                // 搜索模式        if(searchController.isActive)&#123;            let searchBar = searchController.searchBar            let scope = searchBar.scopeButtonTitles![searchBar.selectedScopeButtonIndex]            let deleteTableRowViewSub = UITableViewRowAction(style: .normal, title: SMSOpeartion.DEL.rawValue) &#123; action, index in                let msg = self.filteredsms[index[1]]                deleteItem(date_time: msg.date_time)                self.refreshDataLocal()            &#125;            deleteTableRowViewSub.backgroundColor = .red            if(scope==SMSCategory.FAV.rawValue)&#123;                return [deleteTableRowViewSub]            &#125;else&#123;                let favoriteTableRowViewSub = UITableViewRowAction(style: .normal, title: SMSCategory.FAV.rawValue) &#123; action, index in                    let msg = self.filteredsms[index[1]]                    saveMsg2CoreData(msg: msg)                    self.refreshDataLocal()                &#125;                favoriteTableRowViewSub.backgroundColor = .orange                return [favoriteTableRowViewSub]            &#125;        &#125;                // 普通模式        if(sms[index].category==SMSCategory.SMS.rawValue)&#123;            let favoriteTableRowView = UITableViewRowAction(style: .normal, title: SMSCategory.FAV.rawValue) &#123; action, index in                let msg = self.sms[index[1]]                saveMsg2CoreData(msg: msg)                self.refreshDataLocal()            &#125;            favoriteTableRowView.backgroundColor = .orange            return [favoriteTableRowView]        &#125;else&#123;            let deleteTableRowView = UITableViewRowAction(style: .normal, title: SMSOpeartion.DEL.rawValue) &#123; action, index in                let msg = self.sms[index[1]]                deleteItem(date_time: msg.date_time)                self.refreshDataLocal()            &#125;            deleteTableRowView.backgroundColor = .red            return [deleteTableRowView]        &#125;    &#125;        // TableView cell 赋值    override func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -&gt; UITableViewCell &#123;        let cell = tableView.dequeueReusableCell(withIdentifier: \"Cell\", for: indexPath)                let msg: Msg        if searchController.isActive &#123;            msg = filteredsms[(indexPath as NSIndexPath).row]        &#125; else &#123;            msg = sms[(indexPath as NSIndexPath).row]        &#125;                var titleStr=msg.phone_num        if(msg.code != \"\")&#123;            titleStr=msg.vendor+\":\"+msg.code        &#125;        cell.textLabel!.text = titleStr                cell.detailTextLabel!.text = msg.content        cell.textLabel?.textColor=UIColor.black        cell.detailTextLabel?.textColor=UIColor.gray                // 如果是新消息则加粗并且深色背景显示        if(msg.is_new_msg)&#123;            cell.backgroundColor = UIColor.cyan            cell.textLabel?.font = UIFont.boldSystemFont(ofSize: 16.0)        &#125;else&#123;            cell.backgroundColor = UIColor.white            cell.textLabel?.font = UIFont.systemFont(ofSize: 16.0)        &#125;                // 如果是来电转移提醒则显示        if(msg.content.hasPrefix(\"【来电提醒】\"))&#123;            cell.textLabel?.textColor=UIColor.red        &#125;                //  如果是收藏的消息则显示橘黄色标题        if(msg.category==SMSCategory.FAV.rawValue)&#123;            cell.textLabel?.textColor=UIColor.orange        &#125;        return cell    &#125;        // 跳转详情界面    override func prepare(for segue: UIStoryboardSegue, sender: Any?) &#123;        if segue.identifier == \"showDetail\" &#123;            if let indexPath = tableView.indexPathForSelectedRow &#123;                let msg: Msg                let selectedIndex=(indexPath as NSIndexPath).row                if searchController.isActive &#123;                    msg = filteredsms[selectedIndex]                &#125; else &#123;                    msg = sms[selectedIndex]                &#125;                let controller = (segue.destination as! UINavigationController).topViewController as! DetailViewController                controller.detailMsg = msg                controller.navigationItem.leftBarButtonItem = splitViewController?.displayModeButtonItem                controller.navigationItem.leftItemsSupplementBackButton = true            &#125;        &#125;    &#125;    &#125;// 进入搜索模式触发extension MasterViewController: UISearchResultsUpdating &#123;    func updateSearchResults(for searchController: UISearchController) &#123;        let searchBar = searchController.searchBar        let scope = searchBar.scopeButtonTitles![searchBar.selectedScopeButtonIndex]        filterContentForSearchText(searchController.searchBar.text!, scope: scope)    &#125;&#125;// 用户进行搜索触发extension MasterViewController: UISearchBarDelegate &#123;    func searchBar(_ searchBar: UISearchBar, selectedScopeButtonIndexDidChange selectedScope: Int) &#123;        switch searchBar.text &#123;        case TXT_SET_SERVER :            let alertController = UIAlertController(title: \"服务器信息\",                                                    message: \"请输入服务器信息\", preferredStyle: .alert)            alertController.addTextField &#123;                (textField: UITextField!) -&gt; Void in                textField.text=BASE_HOST                textField.placeholder = \"服务器地址\"            &#125;            alertController.addTextField &#123;                (textField: UITextField!) -&gt; Void in                textField.text=BASE_PORT                textField.placeholder = \"服务器端口\"            &#125;            let cancelAction = UIAlertAction(title: \"取消\", style: .cancel, handler: nil)            let okAction = UIAlertAction(title: \"好的\", style: .default, handler: &#123;                action in                let host = alertController.textFields![0]                let port = alertController.textFields![1]                BASE_HOST=host.text!                BASE_PORT=port.text!                saveServerInfo(host:BASE_HOST,port:BASE_PORT)                                self.showToast(message: \"设置成功\")            &#125;)            alertController.addAction(cancelAction)            alertController.addAction(okAction)            self.present(alertController, animated: true, completion: nil)            break        case TXT_GET_BATTERY :            hud.textLabel.text = \"加载中...\"            hud.show(in: self.view)            hud.dismiss(afterDelay: 8)            fetchBatteryInfo(completionHandler: &#123;                (success, errorReason) in                hud.dismiss()                let alertController = UIAlertController(title: errorReason,                                                        message: nil, preferredStyle: .alert)                //显示提示框                self.present(alertController, animated: true, completion: nil)                                DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + 1)&#123;                    alertController.dismiss(animated: false, completion: nil)                &#125;            &#125;)            break        case TXT_SET_PUSH_ALIAS_AES:            let alertController = UIAlertController(title: \"推送配置信息\",                                                    message: \"请输入推送Alias和aes_key\", preferredStyle: .alert)            alertController.addTextField &#123;                (textField: UITextField!) -&gt; Void in                textField.text=PUSH_ALIAS                textField.placeholder = \"推送Alias\"            &#125;            alertController.addTextField &#123;                (textField: UITextField!) -&gt; Void in                textField.text=AES_KEY                textField.placeholder = \"AES秘钥\"            &#125;            let cancelAction = UIAlertAction(title: \"取消\", style: .cancel, handler: nil)            let okAction = UIAlertAction(title: \"好的\", style: .default, handler: &#123;                action in                let alias_txt = alertController.textFields![0]                let aes_key = alertController.textFields![1]                PUSH_ALIAS=alias_txt.text!                AES_KEY=aes_key.text!                saveServerInfo(push_alias: PUSH_ALIAS, aes_key: AES_KEY)                                JPUSHService.setAlias(PUSH_ALIAS, completion: nil, seq: 888)                                self.showToast(message: \"设置成功\")            &#125;)            alertController.addAction(cancelAction)            alertController.addAction(okAction)            self.present(alertController, animated: true, completion: nil)            break                    default :            print( \"default case\")        &#125;                filterContentForSearchText(searchBar.text!, scope: searchBar.scopeButtonTitles![selectedScope])    &#125;&#125;\nAppDelegate.swift123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204import UIKitimport CoreDataimport UserNotificationsimport RainbowSwift@UIApplicationMainclass AppDelegate: UIResponder, UIApplicationDelegate, UISplitViewControllerDelegate, JPUSHRegisterDelegate &#123;        var window: UIWindow?        func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?) -&gt; Bool &#123;                let entity = JPUSHRegisterEntity()        entity.types = NSInteger(UNAuthorizationOptions.alert.rawValue) |            NSInteger(UNAuthorizationOptions.sound.rawValue) |            NSInteger(UNAuthorizationOptions.badge.rawValue)                JPUSHService.register(forRemoteNotificationConfig: entity, delegate: self)                // 启动JPushSDK        JPUSHService.setup(withOption: nil, appKey: \"4d1xxxxxxxx7\",                           channel: \"Publish Channel\", apsForProduction: false)                JPUSHService.setLogOFF()                // 从数据库获得服务器数据        (BASE_HOST,BASE_PORT,BASE_PATH,PUSH_ALIAS,AES_KEY)=querytServerInfo()        BASE_URL=BASE_HOST+\":\"+String(BASE_PORT)+BASE_PATH        print(\"Server ---- &gt; \\(BASE_URL)\\n\\(PUSH_ALIAS)\\n\\(AES_KEY)\".cyan.bold)                // 为了安全需要手动设置Alias        JPUSHService.setAlias(PUSH_ALIAS, completion: nil, seq: 888)                // 设置导航栏        let splitViewController = window!.rootViewController as! UISplitViewController        let navigationController = splitViewController.viewControllers[splitViewController.viewControllers.count-1] as! UINavigationController        navigationController.topViewController!.navigationItem.leftBarButtonItem = splitViewController.displayModeButtonItem        splitViewController.delegate = self                UISearchBar.appearance().barTintColor = UIColor.candyGreen()        UISearchBar.appearance().tintColor = UIColor.white        UITextField.appearance(whenContainedInInstancesOf: [UISearchBar.self]).tintColor = UIColor.candyGreen()        return true    &#125;        func applicationDidEnterBackground(_ application: UIApplication) &#123;        // 每次APP返回前台，显示主界面而不是详情界面        let splitViewController = window!.rootViewController as! UISplitViewController        let navigationController = splitViewController.viewControllers[splitViewController.viewControllers.count-1] as! UINavigationController        navigationController.popToRootViewController(animated: true)    &#125;        func applicationWillEnterForeground(_ application: UIApplication) &#123;    &#125;        func applicationDidBecomeActive(_ application: UIApplication)&#123;        // 每次从后台恢复刷新消息列表        let splitViewController = window!.rootViewController as! UISplitViewController        let navigationController = splitViewController.viewControllers[splitViewController.viewControllers.count-1] as! UINavigationController        let mastViewController = navigationController.viewControllers[0] as!  UITableViewController as! MasterViewController                if(!mastViewController.sms.isEmpty)&#123;            mastViewController.latestSMSTimeStamp=mastViewController.sms[0].date_time+1  //由于服务器时间戳有小数，取整后会缺失精度，需要cell，否则会重复拉取第一条数据            mastViewController.refreshHeaderString = \"上次刷新时间：\\(convertTimeStamp2FormatDate(timestamp: mastViewController.latestSMSTimeStamp,fomart: \"MM-dd HH:mm\"))\"        &#125;                mastViewController.getDataFromServer(showCirclePB: true)                // 清除APP图标未读红点        UIApplication.shared.applicationIconBadgeNumber=0        // 由于服务器发送的数值一直+1，所以读完要告诉服务器需要清空        JPUSHService.setBadge(0)    &#125;                func applicationWillTerminate(_ application: UIApplication) &#123;        // Called when the application is about to terminate. Save data if appropriate. See also applicationDidEnterBackground:.        // Saves changes in the application's managed object context before the application terminates.        self.saveContext()    &#125;            func application(_ application: UIApplication,                     didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) &#123;        //注册 DeviceToken        JPUSHService.registerDeviceToken(deviceToken)    &#125;        func application(_ application: UIApplication,                     didReceiveRemoteNotification userInfo: [AnyHashable : Any],                     fetchCompletionHandler        completionHandler: @escaping (UIBackgroundFetchResult) -&gt; Void) &#123;        //增加IOS 7的支持        JPUSHService.handleRemoteNotification(userInfo)        completionHandler(UIBackgroundFetchResult.newData)    &#125;        func application(_ application: UIApplication,                     didFailToRegisterForRemoteNotificationsWithError error: Error) &#123;    &#125;        @available(iOS 10.0, *)    func jpushNotificationCenter(_ center: UNUserNotificationCenter!, didReceive response: UNNotificationResponse!, withCompletionHandler completionHandler: (() -&gt; Void)!) &#123;            &#125;        // 前台收到推送直接显示Alter，并且刷新列表    @available(iOS 10.0, *)    func jpushNotificationCenter(_ center: UNUserNotificationCenter!, willPresent notification: UNNotification!,                                 withCompletionHandler completionHandler: ((Int) -&gt; Void)!) &#123;        //        let userInfo = notification.request.content.userInfo        let request = notification.request // 收到推送的请求        let content = request.content // 收到推送的消息内容        //        let badge = content.badge // 推送消息的角标        let body = content.body   // 推送消息体        //        let sound = content.sound // 推送消息的声音        //        let subtitle = content.subtitle // 推送消息的副标题        //        let title = content.title // 推送消息的标题                        let splitViewController = window!.rootViewController as! UISplitViewController        let navigationController = splitViewController.viewControllers[splitViewController.viewControllers.count-1] as! UINavigationController        let mastViewController = navigationController.viewControllers[0] as!  UITableViewController as! MasterViewController                let alertController = UIAlertController(title: body,                                                message: nil, preferredStyle: .alert)        //显示提示框        mastViewController.present(alertController, animated: true, completion: nil)        //两秒钟后自动消失        DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + 1) &#123;            mastViewController.presentedViewController?.dismiss(animated: false, completion: nil)        &#125;                        if(!mastViewController.sms.isEmpty)&#123;            mastViewController.latestSMSTimeStamp=mastViewController.sms[0].date_time+1  //由于服务器时间戳有小数，取整后会缺失精度，需要cell，否则会重复拉取第一条数据            mastViewController.refreshHeaderString = \"上次刷新时间：\\(convertTimeStamp2FormatDate(timestamp: mastViewController.latestSMSTimeStamp,fomart: \"MM-dd HH:mm\"))\"        &#125;        //自动刷新列表        mastViewController.getDataFromServer(showCirclePB: false)    &#125;        func splitViewController(_ splitViewController: UISplitViewController, collapseSecondary secondaryViewController:UIViewController, onto primaryViewController:UIViewController) -&gt; Bool &#123;        guard let secondaryAsNavController = secondaryViewController as? UINavigationController else &#123; return false &#125;        guard let topAsDetailController = secondaryAsNavController.topViewController as? DetailViewController else &#123; return false &#125;        if topAsDetailController.detailMsg == nil &#123;            // Return true to indicate that we have handled the collapse by doing nothing; the secondary controller will be discarded.            return true        &#125;        return false    &#125;        // MARK: - Core Data stack        lazy var persistentContainer: NSPersistentContainer = &#123;        /*         The persistent container for the application. This implementation         creates and returns a container, having loaded the store for the         application to it. This property is optional since there are legitimate         error conditions that could cause the creation of the store to fail.         */        let container = NSPersistentContainer(name: \"Model\")        container.loadPersistentStores(completionHandler: &#123; (storeDescription, error) in            if let error = error as NSError? &#123;                // Replace this implementation with code to handle the error appropriately.                // fatalError() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.                                /*                 Typical reasons for an error here include:                 * The parent directory does not exist, cannot be created, or disallows writing.                 * The persistent store is not accessible, due to permissions or data protection when the device is locked.                 * The device is out of space.                 * The store could not be migrated to the current model version.                 Check the error message to determine what the actual problem was.                 */                fatalError(\"Unresolved error \\(error), \\(error.userInfo)\")            &#125;        &#125;)        return container    &#125;()        // MARK: - Core Data Saving support        func saveContext () &#123;        let context = persistentContainer.viewContext        if context.hasChanges &#123;            do &#123;                try context.save()            &#125; catch &#123;                // Replace this implementation with code to handle the error appropriately.                // fatalError() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.                let nserror = error as NSError                fatalError(\"Unresolved error \\(nserror), \\(nserror.userInfo)\")            &#125;        &#125;    &#125;&#125;extension UIColor &#123;    static func candyGreen() -&gt; UIColor &#123;        return UIColor(red: 67.0/255.0, green: 205.0/255.0, blue: 135.0/255.0, alpha: 1.0)    &#125;&#125;\nCryptoUtils.swift （加解密方法）123456789101112131415161718192021222324252627282930313233343536373839404142434445464748import Foundationimport CryptoSwiftlet aes_cbc_iv = \"6aStDl7YrB4CM3gq\"func aesEncryptBase64(plainStr:String,aes_key:String) -&gt; String &#123;    do &#123;        let aes = try AES(key: aes_key, iv: aes_cbc_iv, padding: .pkcs7)        let ciphertext = try aes.encrypt(Array(plainStr.utf8))        return Data(ciphertext).base64EncodedString()    &#125; catch &#123;        return \"error\"    &#125;&#125; func aesEncryptHex(plain_str:String,aes_key:String) -&gt; String &#123;     do &#123;         let aes = try AES(key: aes_key, iv: aes_cbc_iv, padding: .pkcs7)         let ciphertext = try aes.encrypt(Array(plain_str.utf8))         return Data(ciphertext).toHexString()     &#125; catch &#123;         return \"error\"     &#125; &#125;func aesDecryptBase64(encrypt_base64 : String,aes_key:String) -&gt; String &#123;    do &#123;        guard let data = Data(base64Encoded: encrypt_base64) else &#123; return \"\" &#125;        let aes = try AES(key: aes_key, iv: aes_cbc_iv, padding: .pkcs7)        let ciphertext = try aes.decrypt([UInt8](data))        return String(bytes: Data(ciphertext).bytes, encoding: .utf8) ?? \"Could not decrypt\"    &#125; catch &#123;        return \"error\"    &#125;&#125; func aesDecryptHex(encrypt_hex : String,aes_key:String) -&gt; String &#123;     do &#123;         let data = Array&lt;UInt8&gt;(hex: encrypt_hex)         let aes = try AES(key: aes_key, iv: aes_cbc_iv, padding: .pkcs7)         let ciphertext = try aes.decrypt([UInt8](data))         return String(bytes: Data(ciphertext).bytes, encoding: .utf8) ?? \"Could not decrypt\"     &#125; catch &#123;         return \"error\"     &#125; &#125;\nDetailViewController.swift (消息详情页面)12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667import UIKitclass DetailViewController: UIViewController &#123;        @IBOutlet weak var titleLabel: UILabel!    @IBOutlet weak var dateLabel: UILabel!    @IBOutlet weak var detailTextView: UITextView!        var detailMsg: Msg? &#123;        didSet &#123;            configureView()        &#125;    &#125;        func configureView() &#123;        if let detailMsg = detailMsg &#123;            if let titleLabel = titleLabel,let detailTextView=detailTextView&#123;                // 默认设置标题为对方手机号码                var titleStr=detailMsg.phone_num                // 如果是验证码短信则把验证码设为标题                if (detailMsg.code != \"\")&#123;                    titleStr=detailMsg.vendor+\":\"+detailMsg.code                    // 对于新接收到的验证码消息，使用红色标题显示                    if(detailMsg.is_new_msg)&#123;                        titleLabel.textColor=UIColor.red                    &#125;else&#123;                        titleLabel.textColor=UIColor.black                    &#125;                &#125;                                detailMsg.is_new_msg=false                titleLabel.text = \" \" + titleStr                                dateLabel.text = convertTimeStamp2FormatDate(timestamp:detailMsg.date_time)                                detailTextView.text = \"\\(detailMsg.content)\"                //动态设置高度                let fixedWidth = detailTextView.frame.size.width                detailTextView.sizeThatFits(CGSize(width: fixedWidth, height: CGFloat.greatestFiniteMagnitude))                let newSize = detailTextView.sizeThatFits(CGSize(width: fixedWidth, height: CGFloat.greatestFiniteMagnitude))                var newFrame = detailTextView.frame                newFrame.size = CGSize(width: max(newSize.width, fixedWidth), height: newSize.height)                detailTextView.frame = newFrame;                                                // 设置页面标题                title = detailMsg.category            &#125;        &#125;    &#125;        override func viewDidLoad() &#123;        super.viewDidLoad()        titleLabel.layer.cornerRadius = 10;        titleLabel.clipsToBounds = true                detailTextView.layer.cornerRadius = 10;        detailTextView.clipsToBounds = true                configureView()    &#125;        override func didReceiveMemoryWarning() &#123;        super.didReceiveMemoryWarning()    &#125;    &#125;\nUtils.swift (工具类)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398import Foundationimport Alamofireimport SwiftyJSONimport CoreDatavar BASE_HOST:String=\"\"var BASE_PORT:String=\"\"var BASE_PATH:String=\"\"var BASE_URL:String = \"\"var PUSH_ALIAS:String = \"\"var AES_KEY:String = \"\"let GET_MSG_PATH:String=\"/api/get_sms\"let GET_BATTERY_PATH:String=\"/api/get_battery_level\"let TXT_SET_SERVER=\"Change-server\"  // 更改服务器地址搜索关键字let TXT_SET_PUSH_ALIAS_AES=\"Set-alias-aes\"  // 设置推送aliaslet TXT_GET_BATTERY=\"   \"  //查询电量搜索关键字// 从服务器获取最新短信列表，并按照时间从近到远排序func fetchMsgFromServer(timestamp:Int,direction:String,limit:Int,completionHandler: @escaping    (_ newMsgs:[Msg],_ success:Bool,_ errorReason:String,_ statusCode:Int) -&gt; () )&#123;    var msg = [Msg]()    var reqParamList=[String: Any]()        reqParamList[\"direction\"]=\"down\"    reqParamList[\"timestamp\"]=\"1498413914\"    if(timestamp&gt;0)&#123;        reqParamList[\"timestamp\"]=timestamp        reqParamList[\"limit\"]=limit    &#125;else&#123;        reqParamList[\"limit\"]=50 //  初期启动第一次刷新拉取旧数据时时间戳为-1，拉取旧数据50条    &#125;        let parameters: Parameters = reqParamList        let manager = Alamofire.SessionManager.default    manager.session.configuration.timeoutIntervalForRequest = TimeInterval(8)    manager.session.configuration.timeoutIntervalForRequest = TimeInterval(8)        // 给请求的URL添加随机冗余参数，方便超时取消    let url = BASE_URL+GET_MSG_PATH+\"?id=\"+String(Int(arc4random()%100000)+1)        manager.request(url, method: .post, parameters: parameters, encoding: JSONEncoding.default)        .responseString &#123; response in            if(response.result.isSuccess)&#123;                let j_raw_str=response.result.value                let j_raw_str_utf8 = j_raw_str!.data(using: .utf8)                let j =  JSON(data: j_raw_str_utf8!)                var sub_j_raw_str = j[\"msg\"].stringValue                sub_j_raw_str = aesDecryptHex(encrypt_hex: sub_j_raw_str,aes_key: AES_KEY)                let sub_j_raw_str_utf8 = sub_j_raw_str.data(using: .utf8)                                let sub_j = JSON(data: sub_j_raw_str_utf8!)                for item in sub_j.arrayValue &#123;                    let vendor = item[\"vendor\"]                    let content = item[\"content\"]                    let date_time = item[\"date_time\"]                    let code = item[\"code\"]                    let phone_num = item[\"phone_num\"]                                        let date_time_stamp = Int(String(describing: date_time))                    let is_new_msg = timestamp &gt; 0  //  第一次启动刷新拉取旧数据时时间戳为-1，且不标记为新消息                                        let m = Msg(SMSCategory.SMS.rawValue,\"\\(content)\",\"\\(code)\",\"\\(vendor)\",\"\\(phone_num)\",date_time_stamp!,is_new_msg)                    msg.append(m)                &#125;                // 进行回调                completionHandler(msg,true,\"\",200)            &#125;else&#123;                let errorCode=response.error!._code                var tipText=\"刷新失败\"                switch (response.error!._code)&#123;                case NSURLErrorTimedOut:                    tipText=\"网络超时\"                    break                case NSURLErrorNotConnectedToInternet:                    tipText=\"网络未连接\"                    break                case NSURLErrorNetworkConnectionLost:                    tipText=\"网络连接失去\"                    break                case NSURLErrorBadURL:                    tipText=\"URL错误\"                    break                case NSURLErrorCannotConnectToHost:                    tipText=\"无法连接主机\"                    break                case 53:                    tipText=\"刷新失败\"                    break                default:                    tipText=\"刷新失败\"                &#125;                completionHandler(msg,false,tipText,errorCode)            &#125;    &#125;        // 如果超时8秒，将这个请求取消    DispatchQueue.main.asyncAfter(deadline: DispatchTime.now()+8) &#123;        manager.session.getAllTasks &#123; (tasks) in            tasks.forEach(&#123; (task) in                if(task.originalRequest?.url?.absoluteString == url)&#123;                    task.cancel()                    completionHandler(msg,false,\"网络超时主动关闭\", NSURLErrorTimedOut)                &#125;            &#125;)        &#125;    &#125;&#125;// 获取电量信息func fetchBatteryInfo(completionHandler: @escaping (_ success:Bool,_ errorReason:String) -&gt; () )&#123;    let manager = Alamofire.SessionManager.default    // 因为需要发邮件所以延迟时间设为10秒    manager.session.configuration.timeoutIntervalForRequest = TimeInterval(10)    manager.session.configuration.timeoutIntervalForRequest = TimeInterval(10)        // 给请求的URL添加随机冗余参数，方便超时取消    let url = BASE_URL+GET_BATTERY_PATH+\"?id=\"+String(Int(arc4random()%100000)+1)        manager.request(url, method: .get, encoding: JSONEncoding.default)        .responseJSON &#123; response in            if let value = response.result.value &#123;                let json = JSON(value)                let rsp = Int(String(describing: json[\"rsp\"]))                let msg:String = String(describing: json[\"msg\"])                                if(rsp==200)&#123;                    completionHandler(true,msg)                &#125;else if (rsp == 400) &#123;                    completionHandler(false,msg)                &#125;            &#125;                        if let data = response.data, let utf8Text = String(data: data, encoding: .utf8) &#123;                // 服务器关闭或者超时                if(utf8Text==\"\" || !response.result.isSuccess)&#123;                    completionHandler(false,\"请求失败!\")                &#125;            &#125;    &#125;        // 如果超时10秒，将这个请求取消    DispatchQueue.main.asyncAfter(deadline: DispatchTime.now()+10) &#123;        manager.session.getAllTasks &#123; (tasks) in            tasks.forEach(&#123; (task) in                if(task.originalRequest?.url?.absoluteString == url)&#123;                    task.cancel()                &#125;            &#125;)        &#125;    &#125;&#125;// 转换时间戳为可读时间func convertTimeStamp2FormatDate(timestamp:Int,fomart : String? = nil ) -&gt; String&#123;    let dateFormartString=fomart ?? \"MM月dd日 HH:mm\"    let date = Date(timeIntervalSince1970: TimeInterval(timestamp))    let dateFormatter = DateFormatter()    dateFormatter.timeZone = TimeZone(abbreviation: \"GMT+8\") //Set timezone that you want    dateFormatter.locale = NSLocale.current    dateFormatter.dateFormat = dateFormartString  //Specify your format that you want    let strDate = dateFormatter.string(from: date)    return strDate&#125;extension UIViewController &#123;    func showToast(message : String) &#123;        let toastLabel = UILabel(frame: CGRect(x: self.view.frame.size.width/2 - 150,                                               y: self.view.frame.size.height-150, width: 300, height: 35))        toastLabel.backgroundColor = UIColor.black.withAlphaComponent(0.6)        toastLabel.textColor = UIColor.white        toastLabel.textAlignment = .center;        toastLabel.font = UIFont(name: \"Montserrat-Light\", size: 12.0)        toastLabel.text = message        toastLabel.alpha = 1.0        toastLabel.layer.cornerRadius = 10;        toastLabel.clipsToBounds  =  true        self.view.addSubview(toastLabel)        UIView.animate(withDuration: 4.0, delay: 0.1, options: .curveEaseOut, animations: &#123;            toastLabel.alpha = 0.0        &#125;, completion: &#123;(isCompleted) in            toastLabel.removeFromSuperview()        &#125;)    &#125;&#125;// 向数据库存储短信列表func saveMsg2CoreData(msg:Msg,category:String=SMSCategory.FAV.rawValue)&#123;    //获取管理的数据上下文 对象    let app = UIApplication.shared.delegate as! AppDelegate    let context = app.persistentContainer.viewContext        //创建User对象    let mMsgData = NSEntityDescription.insertNewObject(forEntityName: \"MsgData\",                                                       into: context) as! MsgData    mMsgData.category=category    mMsgData.content = msg.content    mMsgData.code = msg.code    mMsgData.vendor = msg.vendor    mMsgData.phone_num = msg.phone_num    mMsgData.date_time = Int32(msg.date_time)    mMsgData.is_new_msg=msg.is_new_msg        //保存    do &#123;        try context.save()        print(\"保存成功！\")    &#125; catch &#123;        fatalError(\"不能保存：\\(error)\")    &#125;&#125;// 从数据库读取短信列表func fetchMsgFromCoreData(category:String) -&gt; [Msg]&#123;    var msg = [Msg]()        //获取管理的数据上下文 对象    let app = UIApplication.shared.delegate as! AppDelegate    let context = app.persistentContainer.viewContext        //声明数据的请求    let fetchRequest = NSFetchRequest&lt;MsgData&gt;(entityName:\"MsgData\")    fetchRequest.fetchLimit = 10000 //限定查询结果的数量    fetchRequest.fetchOffset = 0 //查询的偏移量        //设置查询条件    let predicate = NSPredicate(format: \"category = '\"+category+\"' \", \"\")    fetchRequest.predicate = predicate    //查询操作    do &#123;        let fetchedObjects = try context.fetch(fetchRequest)                //遍历查询的结果        for info in fetchedObjects &#123;            msg.append(Msg(info.category!,info.content!,info.code!,info.vendor!,                           info.phone_num!,Int(info.date_time),info.is_new_msg))        &#125;        return msg    &#125;    catch &#123;        fatalError(\"不能读取：\\(error)\")    &#125;    return msg&#125;// 从数据库指定项目func deleteItem(date_time:Int)&#123;    //获取管理的数据上下文 对象    let app = UIApplication.shared.delegate as! AppDelegate    let context = app.persistentContainer.viewContext        //声明数据的请求    let fetchRequest = NSFetchRequest&lt;MsgData&gt;(entityName:\"MsgData\")    fetchRequest.fetchLimit = 10000 //限定查询结果的数量    fetchRequest.fetchOffset = 0 //查询的偏移量        //设置查询条件    let predicate = NSPredicate(format: \"date_time = \\(date_time) \", \"\")    fetchRequest.predicate = predicate    //查询操作    do &#123;        let fetchedObjects = try context.fetch(fetchRequest)                //遍历查询的结果        for info in fetchedObjects &#123;            context.delete(info)        &#125;        try! context.save()    &#125;    catch &#123;        fatalError(\"不能删除：\\(error)\")    &#125;&#125;// 从数据库删除所有收藏信息func deleteAll(category:String = SMSCategory.FAV.rawValue)&#123;    //获取管理的数据上下文 对象    let app = UIApplication.shared.delegate as! AppDelegate    let context = app.persistentContainer.viewContext        //声明数据的请求    let fetchRequest = NSFetchRequest&lt;MsgData&gt;(entityName:\"MsgData\")    fetchRequest.fetchLimit = 10000 //限定查询结果的数量    fetchRequest.fetchOffset = 0 //查询的偏移量        //设置查询条件    let predicate = NSPredicate(format: \"category = '\"+category+\"' \", \"\")    fetchRequest.predicate = predicate    //查询操作    do &#123;        let fetchedObjects = try context.fetch(fetchRequest)                //遍历查询的结果        for info in fetchedObjects &#123;            context.delete(info)        &#125;        try! context.save()    &#125;    catch &#123;        fatalError(\"不能删除：\\(error)\")    &#125;&#125;// 向数据库存储服务器信息func saveServerInfo(host:String=BASE_HOST,port:String=BASE_PORT,path:String=BASE_PATH,                    push_alias:String=PUSH_ALIAS,aes_key:String=AES_KEY)&#123;    //获取管理的数据上下文 对象    let app = UIApplication.shared.delegate as! AppDelegate    let context = app.persistentContainer.viewContext        //创建User对象    let mServerData = NSEntityDescription.insertNewObject(forEntityName: \"ServerData\",                                                          into: context) as! ServerData    mServerData.host = host    mServerData.port = port    mServerData.path = path    mServerData.push_alias = push_alias    mServerData.aes_key = aes_key    mServerData.date = Int32(NSDate().timeIntervalSince1970)    //保存    do &#123;        try context.save()        print(\"保存成功！\")    &#125; catch &#123;        fatalError(\"不能保存：\\(error)\")    &#125;&#125;// 从数据库读取服务器信息func querytServerInfo() -&gt; (String,String,String,String,String) &#123;    //获取管理的数据上下文 对象    let app = UIApplication.shared.delegate as! AppDelegate    let context = app.persistentContainer.viewContext        //声明数据的请求    let fetchRequest = NSFetchRequest&lt;ServerData&gt;(entityName:\"ServerData\")    fetchRequest.fetchLimit = 1 //限定查询结果的数量    fetchRequest.fetchOffset = 0 //查询的偏移量        // 只查询最新一条数据，日期降序排列    let sortDescriptor = NSSortDescriptor(key: \"date\", ascending: false)    let sortDescriptors = [sortDescriptor]    fetchRequest.sortDescriptors = sortDescriptors        //查询操作    do &#123;        let fetchedObjects = try context.fetch(fetchRequest)                if(fetchedObjects.count==0)&#123;            //            return (\"http://192.168.2.33\",\"58585\",\"/645atU3453463duWNu455469fJGZ\",\"888\",\"888\")            return (\"https://m.xxx666.ml\",\"58585\",\"/645atU3453463duWNu455469fJGZ\",\"888\",\"888\")        &#125;        let host=fetchedObjects[0].host        let port=fetchedObjects[0].port        let path=fetchedObjects[0].path        let push_alias=fetchedObjects[0].push_alias        let aes_key=fetchedObjects[0].aes_key        return (host!,port!,path!,push_alias!,aes_key!)    &#125;    catch &#123;        fatalError(\"不能读取：\\(error)\")    &#125;    //    return (\"http://192.168.2.33\",\"58585\",\"/645atU3453463duWNu455469fJGZ\",\"888\",\"888\")    return (\"https://m.xxx666.ml\",\"58585\",\"/645atU3453463duWNu455469fJGZ\",\"888\",\"888\")&#125;// 从数据库删除服务器信息func deleteAllServerInfo()&#123;    //获取管理的数据上下文 对象    let app = UIApplication.shared.delegate as! AppDelegate    let context = app.persistentContainer.viewContext        //声明数据的请求    let fetchRequest = NSFetchRequest&lt;ServerData&gt;(entityName:\"ServerData\")    fetchRequest.fetchLimit = 10000 //限定查询结果的数量    fetchRequest.fetchOffset = 0 //查询的偏移量        //查询操作    do &#123;        let fetchedObjects = try context.fetch(fetchRequest)                //遍历查询的结果        for info in fetchedObjects &#123;            context.delete(info)        &#125;        try! context.save()    &#125;    catch &#123;        fatalError(\"不能删除：\\(error)\")    &#125;&#125;\n","dateCreated":"2017-05-27T16:20:00+08:00","dateModified":"2020-11-25T08:18:20+08:00","datePublished":"2017-05-27T16:20:00+08:00","description":"运行在iOS系统上可查看转发短信的App","headline":"旧手机短信转发的解决方案（四）iOS端","image":["https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/swift_logo.png"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/"},"publisher":{"@type":"Organization","name":"AndrewWang","sameAs":["https://github.com/AndrewWang1993","https://stackoverflow.com/users/4209302/andrewwang","mailto:fernando_caudill@outlook.com"],"image":"https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/avatar(7).png","logo":{"@type":"ImageObject","url":"https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/avatar(7).png"}},"url":"https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/","keywords":"开发","thumbnailUrl":"https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/swift_logo.png"}</script>
    <meta name="description" content="运行在iOS系统上可查看转发短信的App">
<meta name="keywords" content="开发">
<meta property="og:type" content="blog">
<meta property="og:title" content="旧手机短信转发的解决方案（四）iOS端">
<meta property="og:url" content="https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/index.html">
<meta property="og:site_name" content="AndrewWang&#39;s Blog">
<meta property="og:description" content="运行在iOS系统上可查看转发短信的App">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/sms_swift.png">
<meta property="og:updated_time" content="2020-11-25T00:18:20.009Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="旧手机短信转发的解决方案（四）iOS端">
<meta name="twitter:description" content="运行在iOS系统上可查看转发短信的App">
<meta name="twitter:image" content="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/sms_swift.png">
<meta name="twitter:creator" content="@https:&#x2F;&#x2F;twitter.com&#x2F;JamesMcMurr">
    
    
        
    
    
        <meta property="og:image" content="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/avatar(7).png"/>
    
    
        <meta property="og:image" content="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/swift_logo.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/swift_logo.png" />
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/css/style-c4ozcsklz4kht2pebhp44xorvyverh23toayhn7i6ubrpyedak24hv1v0hyd.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">AndrewWang&#39;s Blog</a>
    </div>
    
        
            <a class="header-right-picture " href="#about">
        
        
            <img class="header-picture" src="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/avatar(7).png" alt="Author&#39;s picture">
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/avatar(7).png" alt="Author&#39;s picture">
                </a>
                <h4 class="sidebar-profile-name">AndrewWang</h4>
                
                    <h5 class="sidebar-profile-bio"><p>凡是过去，皆为序章<br>须知参差百态，乃是幸福本源<br>邮箱：<a href="mailto:fernando_caudill@outlook.com" target="_blank">fernando_caudill@outlook.com</a></p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/ " title="Home">
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" title="Categories">
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" title="Tags">
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-archives" title="Archives">
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link open-algolia-search" href="#search" title="Search">
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" title="About">
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/AndrewWang1993" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://stackoverflow.com/users/4209302/andrewwang" target="_blank" rel="noopener" title="Stack Overflow">
                    
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="mailto:fernando_caudill@outlook.com" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/atom.xml" title="RSS">
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            旧手机短信转发的解决方案（四）iOS端
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2017-05-27T16:20:00+08:00">
	
		    May 27, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Swift/">Swift</a>, <a class="category-link" href="/categories/Swift/iOS/">iOS</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>运行在iOS系统上可查看转发短信的App<br><a id="more"></a></p>
<center><br><img src="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/sms_swift.png"><br>代码结构<br></center>


<h4 id="Podfile-依赖的库"><a href="#Podfile-依赖的库" class="headerlink" title="Podfile(依赖的库)"></a>Podfile(依赖的库)</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">source 'https:<span class="comment">//github.com/CocoaPods/Specs.git'</span></span><br><span class="line">platform :ios, ‘<span class="number">12.1</span>’</span><br><span class="line">use_frameworks!</span><br><span class="line"> </span><br><span class="line">target ‘<span class="type">CandySearch</span>’ <span class="keyword">do</span></span><br><span class="line">    pod '<span class="type">SwiftyJSON'</span></span><br><span class="line">    pod '<span class="type">Alamofire'</span>, '~&gt; <span class="number">4.4</span>'</span><br><span class="line">    pod '<span class="type">JPush'</span></span><br><span class="line">    pod '<span class="type">CryptoSwift'</span></span><br><span class="line">    pod '<span class="type">JGProgressHUD'</span></span><br><span class="line">    pod '<span class="type">RainbowSwift'</span>, '~&gt; <span class="number">3.0</span>'</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h4 id="Msg-swift-消息实体类"><a href="#Msg-swift-消息实体类" class="headerlink" title="Msg.swift(消息实体类)"></a>Msg.swift(消息实体类)</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息类实体</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Msg</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> category: <span class="type">String</span>  <span class="comment">// 消息种类  SMS，Favorite</span></span><br><span class="line">    <span class="keyword">var</span> content : <span class="type">String</span>  <span class="comment">// 消息内容</span></span><br><span class="line">    <span class="keyword">var</span> code : <span class="type">String</span>     <span class="comment">// 消息包含的验证码</span></span><br><span class="line">    <span class="keyword">var</span> vendor: <span class="type">String</span>    <span class="comment">// 验证码的提供商</span></span><br><span class="line">    <span class="keyword">var</span> phone_num : <span class="type">String</span>  <span class="comment">// 发送方的手机号码</span></span><br><span class="line">    <span class="keyword">var</span> date_time : <span class="type">Int</span>    <span class="comment">//  消息的时间戳</span></span><br><span class="line">    <span class="keyword">var</span> is_new_msg :<span class="type">Bool</span>   <span class="comment">// 是否未打开过</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> category:<span class="type">String</span>,<span class="number">_</span> content:<span class="type">String</span>,<span class="number">_</span> code:<span class="type">String</span>,</span><br><span class="line">         <span class="number">_</span> vendor: <span class="type">String</span>,<span class="number">_</span>  phone_num: <span class="type">String</span>,<span class="number">_</span> date_time:<span class="type">Int</span>,<span class="number">_</span> is_new_msg:<span class="type">Bool</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.category=category</span><br><span class="line">        <span class="keyword">self</span>.content = content</span><br><span class="line">        <span class="keyword">self</span>.code = code</span><br><span class="line">        <span class="keyword">self</span>.vendor = vendor</span><br><span class="line">        <span class="keyword">self</span>.phone_num = phone_num</span><br><span class="line">        <span class="keyword">self</span>.date_time = date_time</span><br><span class="line">        <span class="keyword">self</span>.is_new_msg=is_new_msg</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="MasterViewController-swift（短信列表主界面）"><a href="#MasterViewController-swift（短信列表主界面）" class="headerlink" title="MasterViewController.swift（短信列表主界面）"></a>MasterViewController.swift（短信列表主界面）</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> JGProgressHUD</span><br><span class="line"><span class="keyword">import</span> RainbowSwift</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">SMSCategory</span>:<span class="title">String</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">SMS</span> = <span class="string">"短消息"</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">FAV</span> = <span class="string">"收藏"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">SMSOpeartion</span>:<span class="title">String</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">DEL</span> = <span class="string">"删除"</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">FAV</span> = <span class="string">"收藏"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> hud = <span class="type">JGProgressHUD</span>(style: .dark)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MasterViewController</span>: <span class="title">UITableViewController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> detailViewController: <span class="type">DetailViewController</span>? = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">var</span> sms = [<span class="type">Msg</span>]()</span><br><span class="line">    <span class="keyword">var</span> filteredsms = [<span class="type">Msg</span>]()</span><br><span class="line">    <span class="keyword">let</span> searchController = <span class="type">UISearchController</span>(searchResultsController: <span class="literal">nil</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//拉刷新控制器</span></span><br><span class="line">    <span class="keyword">var</span> refreshTableViewControl = <span class="type">UIRefreshControl</span>()</span><br><span class="line">    <span class="keyword">var</span> refreshHeaderString:<span class="type">String</span> = <span class="string">"下拉刷新数据"</span></span><br><span class="line">    <span class="keyword">var</span> latestSMSTimeStamp:<span class="type">Int</span> = -<span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 界面即将加载时的回调</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        setupSearchController()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> splitViewController = splitViewController &#123;</span><br><span class="line">            <span class="keyword">let</span> controllers = splitViewController.viewControllers</span><br><span class="line">            detailViewController = (controllers[controllers.<span class="built_in">count</span> - <span class="number">1</span>] <span class="keyword">as</span>! <span class="type">UINavigationController</span>).topViewController <span class="keyword">as</span>? <span class="type">DetailViewController</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.tableView.rowHeight = <span class="number">55</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//设置下拉刷新</span></span><br><span class="line">        <span class="keyword">self</span>.refreshControl = <span class="type">UIRefreshControl</span>()</span><br><span class="line">        <span class="keyword">self</span>.refreshControl!.addTarget(<span class="keyword">self</span>, action: #selector(getDataFromServer),<span class="keyword">for</span>: .valueChanged)</span><br><span class="line">        <span class="keyword">self</span>.refreshControl!.attributedTitle = <span class="type">NSAttributedString</span>(string: refreshHeaderString)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//视图将要出现的时候执行</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</span><br><span class="line">        clearsSelectionOnViewWillAppear = splitViewController!.isCollapsed</span><br><span class="line">        <span class="keyword">super</span>.viewWillAppear(animated)</span><br><span class="line">        <span class="comment">// deleteAll()        // 删除已收藏的所有内容(调试用)</span></span><br><span class="line">        refreshDataLocal()  <span class="comment">//  新短信读取后返回消除背景色</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceiveMemoryWarning</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.didReceiveMemoryWarning()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从网络获取数据</span></span><br><span class="line">    <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">getDataFromServer</span><span class="params">(showCirclePB:Bool=<span class="literal">false</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 判断是否显示进度条</span></span><br><span class="line">        <span class="keyword">if</span>(showCirclePB)&#123;</span><br><span class="line">            hud.textLabel.text = <span class="string">"加载中..."</span></span><br><span class="line">            hud.show(<span class="keyword">in</span>: <span class="keyword">self</span>.view)</span><br><span class="line">            hud.dismiss(afterDelay: <span class="number">8</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 防止在自动加载时用户下拉刷新，造成数据重复</span></span><br><span class="line">            <span class="keyword">if</span>(hud.isVisible)&#123;</span><br><span class="line">                <span class="keyword">self</span>.refreshControl?.endRefreshing()</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.refreshControl!.attributedTitle = <span class="type">NSAttributedString</span>(string: refreshHeaderString)</span><br><span class="line">        fetchMsgFromServer(timestamp:latestSMSTimeStamp ,direction:<span class="string">"down"</span>,limit:<span class="number">100</span>)&#123;</span><br><span class="line">            newMsgs,success,errorReason,statusCode <span class="keyword">in</span></span><br><span class="line">            hud.dismiss()</span><br><span class="line">            <span class="comment">// 如果服务器返回正常</span></span><br><span class="line">            <span class="keyword">if</span>(success)&#123;</span><br><span class="line">                <span class="keyword">var</span> merged_sms = <span class="keyword">self</span>.sms</span><br><span class="line">                <span class="keyword">for</span> s_new <span class="keyword">in</span> newMsgs.reversed()&#123;</span><br><span class="line">                    <span class="keyword">var</span> isDupli:<span class="type">Bool</span> = <span class="literal">false</span></span><br><span class="line">                    <span class="keyword">for</span> s_old <span class="keyword">in</span> <span class="keyword">self</span>.sms&#123;</span><br><span class="line">                        <span class="keyword">if</span> s_new.date_time == s_old.date_time&#123;</span><br><span class="line">                            isDupli=<span class="literal">true</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> isDupli==<span class="literal">false</span>&#123;</span><br><span class="line">                        merged_sms=[s_new]+merged_sms</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">self</span>.sms=merged_sms</span><br><span class="line">                <span class="keyword">self</span>.sms = <span class="keyword">self</span>.sms.sorted(by: &#123; $<span class="number">0</span>.date_time &gt; $<span class="number">1</span>.date_time &#125;)</span><br><span class="line">                <span class="keyword">self</span>.tableView.reloadData()</span><br><span class="line">                <span class="keyword">self</span>.refreshControl?.endRefreshing()</span><br><span class="line">                <span class="keyword">if</span>(!<span class="keyword">self</span>.sms.isEmpty)&#123;</span><br><span class="line">                    <span class="keyword">self</span>.latestSMSTimeStamp=<span class="keyword">self</span>.sms[<span class="number">0</span>].date_time+<span class="number">1</span>  <span class="comment">//由于服务器时间戳有小数，取整后会缺失精度，需要cell，否则会重复拉取第一条数据</span></span><br><span class="line">                    <span class="keyword">self</span>.refreshHeaderString = <span class="string">"上次刷新时间：\(convertTimeStamp2FormatDate(timestamp: self.latestSMSTimeStamp,fomart: "</span><span class="type">MM</span>-dd <span class="type">HH</span>:mm<span class="string">"))"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">self</span>.refreshControl?.endRefreshing()</span><br><span class="line">                <span class="keyword">if</span>(statusCode == <span class="number">53</span> || statusCode==<span class="type">NSURLErrorNetworkConnectionLost</span>)&#123;</span><br><span class="line">                    <span class="comment">// 锁屏界面点击notify首次网络请求可能这种错误，所以忽略即可,锁屏时系统关闭网络</span></span><br><span class="line">                    <span class="built_in">print</span>(errorReason)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> alertController = <span class="type">UIAlertController</span>(title: errorReason,</span><br><span class="line">                                                        message: <span class="literal">nil</span>, preferredStyle: .alert)</span><br><span class="line">                <span class="comment">//显示提示框</span></span><br><span class="line">                <span class="keyword">self</span>.present(alertController, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">                <span class="comment">//两秒钟后自动消失</span></span><br><span class="line">                <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: <span class="type">DispatchTime</span>.now() + <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.presentedViewController?.dismiss(animated: <span class="literal">false</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重新加载本地数据并且刷新列表</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">refreshDataLocal</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 过滤出普通短信</span></span><br><span class="line">        <span class="keyword">let</span> smsTemp = sms.<span class="built_in">filter</span> &#123; sms <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> (sms.category == <span class="type">SMSCategory</span>.<span class="type">SMS</span>.rawValue)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获得收藏的短信</span></span><br><span class="line">        <span class="keyword">let</span> favMsg = fetchMsgFromCoreData(category: <span class="type">SMSCategory</span>.<span class="type">FAV</span>.rawValue)</span><br><span class="line">        sms=smsTemp+favMsg</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 排序，将收藏的短信和原始短信放在一起</span></span><br><span class="line">        sms = sms.sorted(by: &#123; $<span class="number">0</span>.date_time &gt; $<span class="number">1</span>.date_time &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解决TAB模式下删除不能立即生效</span></span><br><span class="line">        <span class="keyword">if</span>(searchController.isActive) &#123;</span><br><span class="line">            <span class="keyword">let</span> searchBar = searchController.searchBar</span><br><span class="line">            <span class="keyword">let</span> scope = searchBar.scopeButtonTitles![searchBar.selectedScopeButtonIndex]</span><br><span class="line">            filterContentForSearchText(<span class="string">""</span>,scope: scope)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            tableView.reloadData()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置搜索头</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setupSearchController</span> <span class="params">()</span></span> &#123;</span><br><span class="line">        searchController.searchResultsUpdater = <span class="keyword">self</span></span><br><span class="line">        searchController.dimsBackgroundDuringPresentation = <span class="literal">false</span></span><br><span class="line">        definesPresentationContext = <span class="literal">true</span></span><br><span class="line">        tableView.tableHeaderView = searchController.searchBar</span><br><span class="line">        searchController.searchBar.scopeButtonTitles = [<span class="type">SMSCategory</span>.<span class="type">SMS</span>.rawValue, <span class="type">SMSCategory</span>.<span class="type">FAV</span>.rawValue]</span><br><span class="line">        searchController.searchBar.delegate = <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置搜索过滤和选项卡过滤</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">filterContentForSearchText</span><span class="params">(<span class="number">_</span> searchText: String, scope: String = SMSCategory.SMS.rawValue)</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">        filteredsms = sms.<span class="built_in">filter</span> &#123; sms <span class="keyword">in</span></span><br><span class="line">            <span class="comment">// 首先判断category是否符合</span></span><br><span class="line">            <span class="keyword">if</span> !(sms.category == scope)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 然后判断短信内容是否匹配用户输入的字符</span></span><br><span class="line">            <span class="keyword">return</span> sms.content.lowercased().<span class="built_in">contains</span>(searchText.lowercased()) || searchText == <span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        tableView.reloadData()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// TableView 子视图的数量</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">numberOfSections</span><span class="params">(<span class="keyword">in</span> tableView: UITableView)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置tableview cell 数量</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, numberOfRowsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> searchController.isActive &#123;</span><br><span class="line">            <span class="keyword">return</span> filteredsms.<span class="built_in">count</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sms.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置左滑可编辑</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, canEditRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, commit editingStyle: UITableViewCellEditingStyle, forRowAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"deleted at \(indexPath)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//左滑item加为收藏/删除时的回调</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, editActionsForRowAt: IndexPath)</span></span> -&gt; [<span class="type">UITableViewRowAction</span>]? &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> index = editActionsForRowAt.row</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 搜索模式</span></span><br><span class="line">        <span class="keyword">if</span>(searchController.isActive)&#123;</span><br><span class="line">            <span class="keyword">let</span> searchBar = searchController.searchBar</span><br><span class="line">            <span class="keyword">let</span> scope = searchBar.scopeButtonTitles![searchBar.selectedScopeButtonIndex]</span><br><span class="line">            <span class="keyword">let</span> deleteTableRowViewSub = <span class="type">UITableViewRowAction</span>(style: .normal, title: <span class="type">SMSOpeartion</span>.<span class="type">DEL</span>.rawValue) &#123; action, index <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">let</span> msg = <span class="keyword">self</span>.filteredsms[index[<span class="number">1</span>]]</span><br><span class="line">                deleteItem(date_time: msg.date_time)</span><br><span class="line">                <span class="keyword">self</span>.refreshDataLocal()</span><br><span class="line">            &#125;</span><br><span class="line">            deleteTableRowViewSub.backgroundColor = .red</span><br><span class="line">            <span class="keyword">if</span>(scope==<span class="type">SMSCategory</span>.<span class="type">FAV</span>.rawValue)&#123;</span><br><span class="line">                <span class="keyword">return</span> [deleteTableRowViewSub]</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">let</span> favoriteTableRowViewSub = <span class="type">UITableViewRowAction</span>(style: .normal, title: <span class="type">SMSCategory</span>.<span class="type">FAV</span>.rawValue) &#123; action, index <span class="keyword">in</span></span><br><span class="line">                    <span class="keyword">let</span> msg = <span class="keyword">self</span>.filteredsms[index[<span class="number">1</span>]]</span><br><span class="line">                    saveMsg2CoreData(msg: msg)</span><br><span class="line">                    <span class="keyword">self</span>.refreshDataLocal()</span><br><span class="line">                &#125;</span><br><span class="line">                favoriteTableRowViewSub.backgroundColor = .orange</span><br><span class="line">                <span class="keyword">return</span> [favoriteTableRowViewSub]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 普通模式</span></span><br><span class="line">        <span class="keyword">if</span>(sms[index].category==<span class="type">SMSCategory</span>.<span class="type">SMS</span>.rawValue)&#123;</span><br><span class="line">            <span class="keyword">let</span> favoriteTableRowView = <span class="type">UITableViewRowAction</span>(style: .normal, title: <span class="type">SMSCategory</span>.<span class="type">FAV</span>.rawValue) &#123; action, index <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">let</span> msg = <span class="keyword">self</span>.sms[index[<span class="number">1</span>]]</span><br><span class="line">                saveMsg2CoreData(msg: msg)</span><br><span class="line">                <span class="keyword">self</span>.refreshDataLocal()</span><br><span class="line">            &#125;</span><br><span class="line">            favoriteTableRowView.backgroundColor = .orange</span><br><span class="line">            <span class="keyword">return</span> [favoriteTableRowView]</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> deleteTableRowView = <span class="type">UITableViewRowAction</span>(style: .normal, title: <span class="type">SMSOpeartion</span>.<span class="type">DEL</span>.rawValue) &#123; action, index <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">let</span> msg = <span class="keyword">self</span>.sms[index[<span class="number">1</span>]]</span><br><span class="line">                deleteItem(date_time: msg.date_time)</span><br><span class="line">                <span class="keyword">self</span>.refreshDataLocal()</span><br><span class="line">            &#125;</span><br><span class="line">            deleteTableRowView.backgroundColor = .red</span><br><span class="line">            <span class="keyword">return</span> [deleteTableRowView]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// TableView cell 赋值</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="string">"Cell"</span>, <span class="keyword">for</span>: indexPath)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> msg: <span class="type">Msg</span></span><br><span class="line">        <span class="keyword">if</span> searchController.isActive &#123;</span><br><span class="line">            msg = filteredsms[(indexPath <span class="keyword">as</span> <span class="type">NSIndexPath</span>).row]</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            msg = sms[(indexPath <span class="keyword">as</span> <span class="type">NSIndexPath</span>).row]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> titleStr=msg.phone_num</span><br><span class="line">        <span class="keyword">if</span>(msg.code != <span class="string">""</span>)&#123;</span><br><span class="line">            titleStr=msg.vendor+<span class="string">":"</span>+msg.code</span><br><span class="line">        &#125;</span><br><span class="line">        cell.textLabel!.text = titleStr</span><br><span class="line">        </span><br><span class="line">        cell.detailTextLabel!.text = msg.content</span><br><span class="line">        cell.textLabel?.textColor=<span class="type">UIColor</span>.black</span><br><span class="line">        cell.detailTextLabel?.textColor=<span class="type">UIColor</span>.gray</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果是新消息则加粗并且深色背景显示</span></span><br><span class="line">        <span class="keyword">if</span>(msg.is_new_msg)&#123;</span><br><span class="line">            cell.backgroundColor = <span class="type">UIColor</span>.cyan</span><br><span class="line">            cell.textLabel?.font = <span class="type">UIFont</span>.boldSystemFont(ofSize: <span class="number">16.0</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            cell.backgroundColor = <span class="type">UIColor</span>.white</span><br><span class="line">            cell.textLabel?.font = <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">16.0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果是来电转移提醒则显示</span></span><br><span class="line">        <span class="keyword">if</span>(msg.content.hasPrefix(<span class="string">"【来电提醒】"</span>))&#123;</span><br><span class="line">            cell.textLabel?.textColor=<span class="type">UIColor</span>.red</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//  如果是收藏的消息则显示橘黄色标题</span></span><br><span class="line">        <span class="keyword">if</span>(msg.category==<span class="type">SMSCategory</span>.<span class="type">FAV</span>.rawValue)&#123;</span><br><span class="line">            cell.textLabel?.textColor=<span class="type">UIColor</span>.orange</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 跳转详情界面</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(<span class="keyword">for</span> segue: UIStoryboardSegue, sender: <span class="keyword">Any</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> segue.identifier == <span class="string">"showDetail"</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> indexPath = tableView.indexPathForSelectedRow &#123;</span><br><span class="line">                <span class="keyword">let</span> msg: <span class="type">Msg</span></span><br><span class="line">                <span class="keyword">let</span> selectedIndex=(indexPath <span class="keyword">as</span> <span class="type">NSIndexPath</span>).row</span><br><span class="line">                <span class="keyword">if</span> searchController.isActive &#123;</span><br><span class="line">                    msg = filteredsms[selectedIndex]</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    msg = sms[selectedIndex]</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> controller = (segue.destination <span class="keyword">as</span>! <span class="type">UINavigationController</span>).topViewController <span class="keyword">as</span>! <span class="type">DetailViewController</span></span><br><span class="line">                controller.detailMsg = msg</span><br><span class="line">                controller.navigationItem.leftBarButtonItem = splitViewController?.displayModeButtonItem</span><br><span class="line">                controller.navigationItem.leftItemsSupplementBackButton = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 进入搜索模式触发</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MasterViewController</span>: <span class="title">UISearchResultsUpdating</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">updateSearchResults</span><span class="params">(<span class="keyword">for</span> searchController: UISearchController)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> searchBar = searchController.searchBar</span><br><span class="line">        <span class="keyword">let</span> scope = searchBar.scopeButtonTitles![searchBar.selectedScopeButtonIndex]</span><br><span class="line">        filterContentForSearchText(searchController.searchBar.text!, scope: scope)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 用户进行搜索触发</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MasterViewController</span>: <span class="title">UISearchBarDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">searchBar</span><span class="params">(<span class="number">_</span> searchBar: UISearchBar, selectedScopeButtonIndexDidChange selectedScope: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> searchBar.text &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">TXT_SET_SERVER</span> :</span><br><span class="line">            <span class="keyword">let</span> alertController = <span class="type">UIAlertController</span>(title: <span class="string">"服务器信息"</span>,</span><br><span class="line">                                                    message: <span class="string">"请输入服务器信息"</span>, preferredStyle: .alert)</span><br><span class="line">            alertController.addTextField &#123;</span><br><span class="line">                (textField: <span class="type">UITextField</span>!) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">                textField.text=<span class="type">BASE_HOST</span></span><br><span class="line">                textField.placeholder = <span class="string">"服务器地址"</span></span><br><span class="line">            &#125;</span><br><span class="line">            alertController.addTextField &#123;</span><br><span class="line">                (textField: <span class="type">UITextField</span>!) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">                textField.text=<span class="type">BASE_PORT</span></span><br><span class="line">                textField.placeholder = <span class="string">"服务器端口"</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> cancelAction = <span class="type">UIAlertAction</span>(title: <span class="string">"取消"</span>, style: .cancel, handler: <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">let</span> okAction = <span class="type">UIAlertAction</span>(title: <span class="string">"好的"</span>, style: .<span class="keyword">default</span>, handler: &#123;</span><br><span class="line">                action <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">let</span> host = alertController.textFields![<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">let</span> port = alertController.textFields![<span class="number">1</span>]</span><br><span class="line">                <span class="type">BASE_HOST</span>=host.text!</span><br><span class="line">                <span class="type">BASE_PORT</span>=port.text!</span><br><span class="line">                saveServerInfo(host:<span class="type">BASE_HOST</span>,port:<span class="type">BASE_PORT</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">self</span>.showToast(message: <span class="string">"设置成功"</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">            alertController.addAction(cancelAction)</span><br><span class="line">            alertController.addAction(okAction)</span><br><span class="line">            <span class="keyword">self</span>.present(alertController, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="type">TXT_GET_BATTERY</span> :</span><br><span class="line">            hud.textLabel.text = <span class="string">"加载中..."</span></span><br><span class="line">            hud.show(<span class="keyword">in</span>: <span class="keyword">self</span>.view)</span><br><span class="line">            hud.dismiss(afterDelay: <span class="number">8</span>)</span><br><span class="line">            fetchBatteryInfo(completionHandler: &#123;</span><br><span class="line">                (success, errorReason) <span class="keyword">in</span></span><br><span class="line">                hud.dismiss()</span><br><span class="line">                <span class="keyword">let</span> alertController = <span class="type">UIAlertController</span>(title: errorReason,</span><br><span class="line">                                                        message: <span class="literal">nil</span>, preferredStyle: .alert)</span><br><span class="line">                <span class="comment">//显示提示框</span></span><br><span class="line">                <span class="keyword">self</span>.present(alertController, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: <span class="type">DispatchTime</span>.now() + <span class="number">1</span>)&#123;</span><br><span class="line">                    alertController.dismiss(animated: <span class="literal">false</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="type">TXT_SET_PUSH_ALIAS_AES</span>:</span><br><span class="line">            <span class="keyword">let</span> alertController = <span class="type">UIAlertController</span>(title: <span class="string">"推送配置信息"</span>,</span><br><span class="line">                                                    message: <span class="string">"请输入推送Alias和aes_key"</span>, preferredStyle: .alert)</span><br><span class="line">            alertController.addTextField &#123;</span><br><span class="line">                (textField: <span class="type">UITextField</span>!) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">                textField.text=<span class="type">PUSH_ALIAS</span></span><br><span class="line">                textField.placeholder = <span class="string">"推送Alias"</span></span><br><span class="line">            &#125;</span><br><span class="line">            alertController.addTextField &#123;</span><br><span class="line">                (textField: <span class="type">UITextField</span>!) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">                textField.text=<span class="type">AES_KEY</span></span><br><span class="line">                textField.placeholder = <span class="string">"AES秘钥"</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> cancelAction = <span class="type">UIAlertAction</span>(title: <span class="string">"取消"</span>, style: .cancel, handler: <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">let</span> okAction = <span class="type">UIAlertAction</span>(title: <span class="string">"好的"</span>, style: .<span class="keyword">default</span>, handler: &#123;</span><br><span class="line">                action <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">let</span> alias_txt = alertController.textFields![<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">let</span> aes_key = alertController.textFields![<span class="number">1</span>]</span><br><span class="line">                <span class="type">PUSH_ALIAS</span>=alias_txt.text!</span><br><span class="line">                <span class="type">AES_KEY</span>=aes_key.text!</span><br><span class="line">                saveServerInfo(push_alias: <span class="type">PUSH_ALIAS</span>, aes_key: <span class="type">AES_KEY</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="type">JPUSHService</span>.setAlias(<span class="type">PUSH_ALIAS</span>, completion: <span class="literal">nil</span>, seq: <span class="number">888</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">self</span>.showToast(message: <span class="string">"设置成功"</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">            alertController.addAction(cancelAction)</span><br><span class="line">            alertController.addAction(okAction)</span><br><span class="line">            <span class="keyword">self</span>.present(alertController, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span> :</span><br><span class="line">            <span class="built_in">print</span>( <span class="string">"default case"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        filterContentForSearchText(searchBar.text!, scope: searchBar.scopeButtonTitles![selectedScope])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AppDelegate-swift"><a href="#AppDelegate-swift" class="headerlink" title="AppDelegate.swift"></a>AppDelegate.swift</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> CoreData</span><br><span class="line"><span class="keyword">import</span> UserNotifications</span><br><span class="line"><span class="keyword">import</span> RainbowSwift</span><br><span class="line"></span><br><span class="line"><span class="meta">@UIApplicationMain</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppDelegate</span>: <span class="title">UIResponder</span>, <span class="title">UIApplicationDelegate</span>, <span class="title">UISplitViewControllerDelegate</span>, <span class="title">JPUSHRegisterDelegate</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> window: <span class="type">UIWindow</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: <span class="keyword">Any</span>]?)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> entity = <span class="type">JPUSHRegisterEntity</span>()</span><br><span class="line">        entity.types = <span class="type">NSInteger</span>(<span class="type">UNAuthorizationOptions</span>.alert.rawValue) |</span><br><span class="line">            <span class="type">NSInteger</span>(<span class="type">UNAuthorizationOptions</span>.sound.rawValue) |</span><br><span class="line">            <span class="type">NSInteger</span>(<span class="type">UNAuthorizationOptions</span>.badge.rawValue)</span><br><span class="line">        </span><br><span class="line">        <span class="type">JPUSHService</span>.register(forRemoteNotificationConfig: entity, delegate: <span class="keyword">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启动JPushSDK</span></span><br><span class="line">        <span class="type">JPUSHService</span>.setup(withOption: <span class="literal">nil</span>, appKey: <span class="string">"4d1xxxxxxxx7"</span>,</span><br><span class="line">                           channel: <span class="string">"Publish Channel"</span>, apsForProduction: <span class="literal">false</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="type">JPUSHService</span>.setLogOFF()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 从数据库获得服务器数据</span></span><br><span class="line">        (<span class="type">BASE_HOST</span>,<span class="type">BASE_PORT</span>,<span class="type">BASE_PATH</span>,<span class="type">PUSH_ALIAS</span>,<span class="type">AES_KEY</span>)=querytServerInfo()</span><br><span class="line">        <span class="type">BASE_URL</span>=<span class="type">BASE_HOST</span>+<span class="string">":"</span>+<span class="type">String</span>(<span class="type">BASE_PORT</span>)+<span class="type">BASE_PATH</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Server ---- &gt; \(BASE_URL)\n\(PUSH_ALIAS)\n\(AES_KEY)"</span>.cyan.bold)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 为了安全需要手动设置Alias</span></span><br><span class="line">        <span class="type">JPUSHService</span>.setAlias(<span class="type">PUSH_ALIAS</span>, completion: <span class="literal">nil</span>, seq: <span class="number">888</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置导航栏</span></span><br><span class="line">        <span class="keyword">let</span> splitViewController = window!.rootViewController <span class="keyword">as</span>! <span class="type">UISplitViewController</span></span><br><span class="line">        <span class="keyword">let</span> navigationController = splitViewController.viewControllers[splitViewController.viewControllers.<span class="built_in">count</span>-<span class="number">1</span>] <span class="keyword">as</span>! <span class="type">UINavigationController</span></span><br><span class="line">        navigationController.topViewController!.navigationItem.leftBarButtonItem = splitViewController.displayModeButtonItem</span><br><span class="line">        splitViewController.delegate = <span class="keyword">self</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">UISearchBar</span>.appearance().barTintColor = <span class="type">UIColor</span>.candyGreen()</span><br><span class="line">        <span class="type">UISearchBar</span>.appearance().tintColor = <span class="type">UIColor</span>.white</span><br><span class="line">        <span class="type">UITextField</span>.appearance(whenContainedInInstancesOf: [<span class="type">UISearchBar</span>.<span class="keyword">self</span>]).tintColor = <span class="type">UIColor</span>.candyGreen()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">applicationDidEnterBackground</span><span class="params">(<span class="number">_</span> application: UIApplication)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 每次APP返回前台，显示主界面而不是详情界面</span></span><br><span class="line">        <span class="keyword">let</span> splitViewController = window!.rootViewController <span class="keyword">as</span>! <span class="type">UISplitViewController</span></span><br><span class="line">        <span class="keyword">let</span> navigationController = splitViewController.viewControllers[splitViewController.viewControllers.<span class="built_in">count</span>-<span class="number">1</span>] <span class="keyword">as</span>! <span class="type">UINavigationController</span></span><br><span class="line">        navigationController.popToRootViewController(animated: <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">applicationWillEnterForeground</span><span class="params">(<span class="number">_</span> application: UIApplication)</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">applicationDidBecomeActive</span><span class="params">(<span class="number">_</span> application: UIApplication)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 每次从后台恢复刷新消息列表</span></span><br><span class="line">        <span class="keyword">let</span> splitViewController = window!.rootViewController <span class="keyword">as</span>! <span class="type">UISplitViewController</span></span><br><span class="line">        <span class="keyword">let</span> navigationController = splitViewController.viewControllers[splitViewController.viewControllers.<span class="built_in">count</span>-<span class="number">1</span>] <span class="keyword">as</span>! <span class="type">UINavigationController</span></span><br><span class="line">        <span class="keyword">let</span> mastViewController = navigationController.viewControllers[<span class="number">0</span>] <span class="keyword">as</span>!  <span class="type">UITableViewController</span> <span class="keyword">as</span>! <span class="type">MasterViewController</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(!mastViewController.sms.isEmpty)&#123;</span><br><span class="line">            mastViewController.latestSMSTimeStamp=mastViewController.sms[<span class="number">0</span>].date_time+<span class="number">1</span>  <span class="comment">//由于服务器时间戳有小数，取整后会缺失精度，需要cell，否则会重复拉取第一条数据</span></span><br><span class="line">            mastViewController.refreshHeaderString = <span class="string">"上次刷新时间：\(convertTimeStamp2FormatDate(timestamp: mastViewController.latestSMSTimeStamp,fomart: "</span><span class="type">MM</span>-dd <span class="type">HH</span>:mm<span class="string">"))"</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        mastViewController.getDataFromServer(showCirclePB: <span class="literal">true</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 清除APP图标未读红点</span></span><br><span class="line">        <span class="type">UIApplication</span>.shared.applicationIconBadgeNumber=<span class="number">0</span></span><br><span class="line">        <span class="comment">// 由于服务器发送的数值一直+1，所以读完要告诉服务器需要清空</span></span><br><span class="line">        <span class="type">JPUSHService</span>.setBadge(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">applicationWillTerminate</span><span class="params">(<span class="number">_</span> application: UIApplication)</span></span> &#123;</span><br><span class="line">        <span class="comment">// Called when the application is about to terminate. Save data if appropriate. See also applicationDidEnterBackground:.</span></span><br><span class="line">        <span class="comment">// Saves changes in the application's managed object context before the application terminates.</span></span><br><span class="line">        <span class="keyword">self</span>.saveContext()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication,</span></span></span><br><span class="line"><span class="function"><span class="params">                     didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data)</span></span> &#123;</span><br><span class="line">        <span class="comment">//注册 DeviceToken</span></span><br><span class="line">        <span class="type">JPUSHService</span>.registerDeviceToken(deviceToken)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication,</span></span></span><br><span class="line"><span class="function"><span class="params">                     didReceiveRemoteNotification userInfo: [AnyHashable : <span class="keyword">Any</span>],</span></span></span><br><span class="line"><span class="function"><span class="params">                     fetchCompletionHandler</span></span></span><br><span class="line"><span class="function"><span class="params">        completionHandler: @escaping <span class="params">(UIBackgroundFetchResult)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="comment">//增加IOS 7的支持</span></span><br><span class="line">        <span class="type">JPUSHService</span>.handleRemoteNotification(userInfo)</span><br><span class="line">        completionHandler(<span class="type">UIBackgroundFetchResult</span>.newData)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication,</span></span></span><br><span class="line"><span class="function"><span class="params">                     didFailToRegisterForRemoteNotificationsWithError error: Error)</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@available</span>(iOS <span class="number">10.0</span>, *)</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">jpushNotificationCenter</span><span class="params">(<span class="number">_</span> center: UNUserNotificationCenter!, didReceive response: UNNotificationResponse!, withCompletionHandler completionHandler: <span class="params">(<span class="params">()</span></span></span></span> -&gt; <span class="type">Void</span>)!) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 前台收到推送直接显示Alter，并且刷新列表</span></span><br><span class="line">    <span class="meta">@available</span>(iOS <span class="number">10.0</span>, *)</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">jpushNotificationCenter</span><span class="params">(<span class="number">_</span> center: UNUserNotificationCenter!, willPresent notification: UNNotification!,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 withCompletionHandler completionHandler: <span class="params">(<span class="params">(Int)</span></span></span></span> -&gt; <span class="type">Void</span>)!) &#123;</span><br><span class="line">        <span class="comment">//        let userInfo = notification.request.content.userInfo</span></span><br><span class="line">        <span class="keyword">let</span> request = notification.request <span class="comment">// 收到推送的请求</span></span><br><span class="line">        <span class="keyword">let</span> content = request.content <span class="comment">// 收到推送的消息内容</span></span><br><span class="line">        <span class="comment">//        let badge = content.badge // 推送消息的角标</span></span><br><span class="line">        <span class="keyword">let</span> body = content.body   <span class="comment">// 推送消息体</span></span><br><span class="line">        <span class="comment">//        let sound = content.sound // 推送消息的声音</span></span><br><span class="line">        <span class="comment">//        let subtitle = content.subtitle // 推送消息的副标题</span></span><br><span class="line">        <span class="comment">//        let title = content.title // 推送消息的标题</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> splitViewController = window!.rootViewController <span class="keyword">as</span>! <span class="type">UISplitViewController</span></span><br><span class="line">        <span class="keyword">let</span> navigationController = splitViewController.viewControllers[splitViewController.viewControllers.<span class="built_in">count</span>-<span class="number">1</span>] <span class="keyword">as</span>! <span class="type">UINavigationController</span></span><br><span class="line">        <span class="keyword">let</span> mastViewController = navigationController.viewControllers[<span class="number">0</span>] <span class="keyword">as</span>!  <span class="type">UITableViewController</span> <span class="keyword">as</span>! <span class="type">MasterViewController</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> alertController = <span class="type">UIAlertController</span>(title: body,</span><br><span class="line">                                                message: <span class="literal">nil</span>, preferredStyle: .alert)</span><br><span class="line">        <span class="comment">//显示提示框</span></span><br><span class="line">        mastViewController.present(alertController, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">        <span class="comment">//两秒钟后自动消失</span></span><br><span class="line">        <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: <span class="type">DispatchTime</span>.now() + <span class="number">1</span>) &#123;</span><br><span class="line">            mastViewController.presentedViewController?.dismiss(animated: <span class="literal">false</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(!mastViewController.sms.isEmpty)&#123;</span><br><span class="line">            mastViewController.latestSMSTimeStamp=mastViewController.sms[<span class="number">0</span>].date_time+<span class="number">1</span>  <span class="comment">//由于服务器时间戳有小数，取整后会缺失精度，需要cell，否则会重复拉取第一条数据</span></span><br><span class="line">            mastViewController.refreshHeaderString = <span class="string">"上次刷新时间：\(convertTimeStamp2FormatDate(timestamp: mastViewController.latestSMSTimeStamp,fomart: "</span><span class="type">MM</span>-dd <span class="type">HH</span>:mm<span class="string">"))"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//自动刷新列表</span></span><br><span class="line">        mastViewController.getDataFromServer(showCirclePB: <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">splitViewController</span><span class="params">(<span class="number">_</span> splitViewController: UISplitViewController, collapseSecondary secondaryViewController:UIViewController, onto primaryViewController:UIViewController)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> secondaryAsNavController = secondaryViewController <span class="keyword">as</span>? <span class="type">UINavigationController</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">false</span> &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> topAsDetailController = secondaryAsNavController.topViewController <span class="keyword">as</span>? <span class="type">DetailViewController</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">false</span> &#125;</span><br><span class="line">        <span class="keyword">if</span> topAsDetailController.detailMsg == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// Return true to indicate that we have handled the collapse by doing nothing; the secondary controller will be discarded.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - Core Data stack</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> persistentContainer: <span class="type">NSPersistentContainer</span> = &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         The persistent container for the application. This implementation</span></span><br><span class="line"><span class="comment">         creates and returns a container, having loaded the store for the</span></span><br><span class="line"><span class="comment">         application to it. This property is optional since there are legitimate</span></span><br><span class="line"><span class="comment">         error conditions that could cause the creation of the store to fail.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">let</span> container = <span class="type">NSPersistentContainer</span>(name: <span class="string">"Model"</span>)</span><br><span class="line">        container.loadPersistentStores(completionHandler: &#123; (storeDescription, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> error = error <span class="keyword">as</span> <span class="type">NSError</span>? &#123;</span><br><span class="line">                <span class="comment">// Replace this implementation with code to handle the error appropriately.</span></span><br><span class="line">                <span class="comment">// fatalError() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 Typical reasons for an error here include:</span></span><br><span class="line"><span class="comment">                 * The parent directory does not exist, cannot be created, or disallows writing.</span></span><br><span class="line"><span class="comment">                 * The persistent store is not accessible, due to permissions or data protection when the device is locked.</span></span><br><span class="line"><span class="comment">                 * The device is out of space.</span></span><br><span class="line"><span class="comment">                 * The store could not be migrated to the current model version.</span></span><br><span class="line"><span class="comment">                 Check the error message to determine what the actual problem was.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="built_in">fatalError</span>(<span class="string">"Unresolved error \(error), \(error.userInfo)"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> container</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - Core Data Saving support</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">saveContext</span> <span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> context = persistentContainer.viewContext</span><br><span class="line">        <span class="keyword">if</span> context.hasChanges &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> context.save()</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="comment">// Replace this implementation with code to handle the error appropriately.</span></span><br><span class="line">                <span class="comment">// fatalError() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.</span></span><br><span class="line">                <span class="keyword">let</span> nserror = error <span class="keyword">as</span> <span class="type">NSError</span></span><br><span class="line">                <span class="built_in">fatalError</span>(<span class="string">"Unresolved error \(nserror), \(nserror.userInfo)"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIColor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">candyGreen</span><span class="params">()</span></span> -&gt; <span class="type">UIColor</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">UIColor</span>(red: <span class="number">67.0</span>/<span class="number">255.0</span>, green: <span class="number">205.0</span>/<span class="number">255.0</span>, blue: <span class="number">135.0</span>/<span class="number">255.0</span>, alpha: <span class="number">1.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="CryptoUtils-swift-（加解密方法）"><a href="#CryptoUtils-swift-（加解密方法）" class="headerlink" title="CryptoUtils.swift （加解密方法）"></a>CryptoUtils.swift （加解密方法）</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> CryptoSwift</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> aes_cbc_iv = <span class="string">"6aStDl7YrB4CM3gq"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">aesEncryptBase64</span><span class="params">(plainStr:String,aes_key:String)</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> aes = <span class="keyword">try</span> <span class="type">AES</span>(key: aes_key, iv: aes_cbc_iv, padding: .pkcs7)</span><br><span class="line">        <span class="keyword">let</span> ciphertext = <span class="keyword">try</span> aes.encrypt(<span class="type">Array</span>(plainStr.utf8))</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Data</span>(ciphertext).base64EncodedString()</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">aesEncryptHex</span><span class="params">(plain_str:String,aes_key:String)</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">     <span class="keyword">do</span> &#123;</span><br><span class="line">         <span class="keyword">let</span> aes = <span class="keyword">try</span> <span class="type">AES</span>(key: aes_key, iv: aes_cbc_iv, padding: .pkcs7)</span><br><span class="line">         <span class="keyword">let</span> ciphertext = <span class="keyword">try</span> aes.encrypt(<span class="type">Array</span>(plain_str.utf8))</span><br><span class="line">         <span class="keyword">return</span> <span class="type">Data</span>(ciphertext).toHexString()</span><br><span class="line">     &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">"error"</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">aesDecryptBase64</span><span class="params">(encrypt_base64 : String,aes_key:String)</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> data = <span class="type">Data</span>(base64Encoded: encrypt_base64) <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="string">""</span> &#125;</span><br><span class="line">        <span class="keyword">let</span> aes = <span class="keyword">try</span> <span class="type">AES</span>(key: aes_key, iv: aes_cbc_iv, padding: .pkcs7)</span><br><span class="line">        <span class="keyword">let</span> ciphertext = <span class="keyword">try</span> aes.decrypt([<span class="type">UInt8</span>](data))</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>(bytes: <span class="type">Data</span>(ciphertext).bytes, encoding: .utf8) ?? <span class="string">"Could not decrypt"</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">aesDecryptHex</span><span class="params">(encrypt_hex : String,aes_key:String)</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">     <span class="keyword">do</span> &#123;</span><br><span class="line">         <span class="keyword">let</span> data = <span class="type">Array</span>&lt;<span class="type">UInt8</span>&gt;(hex: encrypt_hex)</span><br><span class="line">         <span class="keyword">let</span> aes = <span class="keyword">try</span> <span class="type">AES</span>(key: aes_key, iv: aes_cbc_iv, padding: .pkcs7)</span><br><span class="line">         <span class="keyword">let</span> ciphertext = <span class="keyword">try</span> aes.decrypt([<span class="type">UInt8</span>](data))</span><br><span class="line">         <span class="keyword">return</span> <span class="type">String</span>(bytes: <span class="type">Data</span>(ciphertext).bytes, encoding: .utf8) ?? <span class="string">"Could not decrypt"</span></span><br><span class="line">     &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">"error"</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="DetailViewController-swift-消息详情页面"><a href="#DetailViewController-swift-消息详情页面" class="headerlink" title="DetailViewController.swift (消息详情页面)"></a>DetailViewController.swift (消息详情页面)</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DetailViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> titleLabel: <span class="type">UILabel</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> dateLabel: <span class="type">UILabel</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> detailTextView: <span class="type">UITextView</span>!</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> detailMsg: <span class="type">Msg</span>? &#123;</span><br><span class="line">        <span class="keyword">didSet</span> &#123;</span><br><span class="line">            configureView()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">configureView</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> detailMsg = detailMsg &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> titleLabel = titleLabel,<span class="keyword">let</span> detailTextView=detailTextView&#123;</span><br><span class="line">                <span class="comment">// 默认设置标题为对方手机号码</span></span><br><span class="line">                <span class="keyword">var</span> titleStr=detailMsg.phone_num</span><br><span class="line">                <span class="comment">// 如果是验证码短信则把验证码设为标题</span></span><br><span class="line">                <span class="keyword">if</span> (detailMsg.code != <span class="string">""</span>)&#123;</span><br><span class="line">                    titleStr=detailMsg.vendor+<span class="string">":"</span>+detailMsg.code</span><br><span class="line">                    <span class="comment">// 对于新接收到的验证码消息，使用红色标题显示</span></span><br><span class="line">                    <span class="keyword">if</span>(detailMsg.is_new_msg)&#123;</span><br><span class="line">                        titleLabel.textColor=<span class="type">UIColor</span>.red</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        titleLabel.textColor=<span class="type">UIColor</span>.black</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                detailMsg.is_new_msg=<span class="literal">false</span></span><br><span class="line">                titleLabel.text = <span class="string">" "</span> + titleStr</span><br><span class="line">                </span><br><span class="line">                dateLabel.text = convertTimeStamp2FormatDate(timestamp:detailMsg.date_time)</span><br><span class="line">                </span><br><span class="line">                detailTextView.text = <span class="string">"\(detailMsg.content)"</span></span><br><span class="line">                <span class="comment">//动态设置高度</span></span><br><span class="line">                <span class="keyword">let</span> fixedWidth = detailTextView.frame.size.width</span><br><span class="line">                detailTextView.sizeThatFits(<span class="type">CGSize</span>(width: fixedWidth, height: <span class="type">CGFloat</span>.greatestFiniteMagnitude))</span><br><span class="line">                <span class="keyword">let</span> newSize = detailTextView.sizeThatFits(<span class="type">CGSize</span>(width: fixedWidth, height: <span class="type">CGFloat</span>.greatestFiniteMagnitude))</span><br><span class="line">                <span class="keyword">var</span> newFrame = detailTextView.frame</span><br><span class="line">                newFrame.size = <span class="type">CGSize</span>(width: <span class="built_in">max</span>(newSize.width, fixedWidth), height: newSize.height)</span><br><span class="line">                detailTextView.frame = newFrame;</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 设置页面标题</span></span><br><span class="line">                title = detailMsg.category</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">        titleLabel.layer.cornerRadius = <span class="number">10</span>;</span><br><span class="line">        titleLabel.clipsToBounds = <span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">        detailTextView.layer.cornerRadius = <span class="number">10</span>;</span><br><span class="line">        detailTextView.clipsToBounds = <span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">        configureView()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceiveMemoryWarning</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.didReceiveMemoryWarning()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Utils-swift-工具类"><a href="#Utils-swift-工具类" class="headerlink" title="Utils.swift (工具类)"></a>Utils.swift (工具类)</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Alamofire</span><br><span class="line"><span class="keyword">import</span> SwiftyJSON</span><br><span class="line"><span class="keyword">import</span> CoreData</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="type">BASE_HOST</span>:<span class="type">String</span>=<span class="string">""</span></span><br><span class="line"><span class="keyword">var</span> <span class="type">BASE_PORT</span>:<span class="type">String</span>=<span class="string">""</span></span><br><span class="line"><span class="keyword">var</span> <span class="type">BASE_PATH</span>:<span class="type">String</span>=<span class="string">""</span></span><br><span class="line"><span class="keyword">var</span> <span class="type">BASE_URL</span>:<span class="type">String</span> = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="type">PUSH_ALIAS</span>:<span class="type">String</span> = <span class="string">""</span></span><br><span class="line"><span class="keyword">var</span> <span class="type">AES_KEY</span>:<span class="type">String</span> = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="type">GET_MSG_PATH</span>:<span class="type">String</span>=<span class="string">"/api/get_sms"</span></span><br><span class="line"><span class="keyword">let</span> <span class="type">GET_BATTERY_PATH</span>:<span class="type">String</span>=<span class="string">"/api/get_battery_level"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="type">TXT_SET_SERVER</span>=<span class="string">"Change-server"</span>  <span class="comment">// 更改服务器地址搜索关键字</span></span><br><span class="line"><span class="keyword">let</span> <span class="type">TXT_SET_PUSH_ALIAS_AES</span>=<span class="string">"Set-alias-aes"</span>  <span class="comment">// 设置推送alias</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="type">TXT_GET_BATTERY</span>=<span class="string">"   "</span>  <span class="comment">//查询电量搜索关键字</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从服务器获取最新短信列表，并按照时间从近到远排序</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetchMsgFromServer</span><span class="params">(timestamp:Int,direction:String,limit:Int,completionHandler: @escaping</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="params">(<span class="number">_</span> newMsgs:[Msg],<span class="number">_</span> success:Bool,<span class="number">_</span> errorReason:String,<span class="number">_</span> statusCode:Int)</span></span></span> -&gt; () )&#123;</span><br><span class="line">    <span class="keyword">var</span> msg = [<span class="type">Msg</span>]()</span><br><span class="line">    <span class="keyword">var</span> reqParamList=[<span class="type">String</span>: <span class="type">Any</span>]()</span><br><span class="line">    </span><br><span class="line">    reqParamList[<span class="string">"direction"</span>]=<span class="string">"down"</span></span><br><span class="line">    reqParamList[<span class="string">"timestamp"</span>]=<span class="string">"1498413914"</span></span><br><span class="line">    <span class="keyword">if</span>(timestamp&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        reqParamList[<span class="string">"timestamp"</span>]=timestamp</span><br><span class="line">        reqParamList[<span class="string">"limit"</span>]=limit</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        reqParamList[<span class="string">"limit"</span>]=<span class="number">50</span> <span class="comment">//  初期启动第一次刷新拉取旧数据时时间戳为-1，拉取旧数据50条</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> parameters: <span class="type">Parameters</span> = reqParamList</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> manager = <span class="type">Alamofire</span>.<span class="type">SessionManager</span>.<span class="keyword">default</span></span><br><span class="line">    manager.session.configuration.timeoutIntervalForRequest = <span class="type">TimeInterval</span>(<span class="number">8</span>)</span><br><span class="line">    manager.session.configuration.timeoutIntervalForRequest = <span class="type">TimeInterval</span>(<span class="number">8</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 给请求的URL添加随机冗余参数，方便超时取消</span></span><br><span class="line">    <span class="keyword">let</span> url = <span class="type">BASE_URL</span>+<span class="type">GET_MSG_PATH</span>+<span class="string">"?id="</span>+<span class="type">String</span>(<span class="type">Int</span>(arc4random()%<span class="number">100000</span>)+<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    manager.request(url, method: .post, parameters: parameters, encoding: <span class="type">JSONEncoding</span>.<span class="keyword">default</span>)</span><br><span class="line">        .responseString &#123; response <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span>(response.result.isSuccess)&#123;</span><br><span class="line">                <span class="keyword">let</span> j_raw_str=response.result.value</span><br><span class="line">                <span class="keyword">let</span> j_raw_str_utf8 = j_raw_str!.data(using: .utf8)</span><br><span class="line">                <span class="keyword">let</span> j =  <span class="type">JSON</span>(data: j_raw_str_utf8!)</span><br><span class="line">                <span class="keyword">var</span> sub_j_raw_str = j[<span class="string">"msg"</span>].stringValue</span><br><span class="line">                sub_j_raw_str = aesDecryptHex(encrypt_hex: sub_j_raw_str,aes_key: <span class="type">AES_KEY</span>)</span><br><span class="line">                <span class="keyword">let</span> sub_j_raw_str_utf8 = sub_j_raw_str.data(using: .utf8)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">let</span> sub_j = <span class="type">JSON</span>(data: sub_j_raw_str_utf8!)</span><br><span class="line">                <span class="keyword">for</span> item <span class="keyword">in</span> sub_j.arrayValue &#123;</span><br><span class="line">                    <span class="keyword">let</span> vendor = item[<span class="string">"vendor"</span>]</span><br><span class="line">                    <span class="keyword">let</span> content = item[<span class="string">"content"</span>]</span><br><span class="line">                    <span class="keyword">let</span> date_time = item[<span class="string">"date_time"</span>]</span><br><span class="line">                    <span class="keyword">let</span> code = item[<span class="string">"code"</span>]</span><br><span class="line">                    <span class="keyword">let</span> phone_num = item[<span class="string">"phone_num"</span>]</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">let</span> date_time_stamp = <span class="type">Int</span>(<span class="type">String</span>(describing: date_time))</span><br><span class="line">                    <span class="keyword">let</span> is_new_msg = timestamp &gt; <span class="number">0</span>  <span class="comment">//  第一次启动刷新拉取旧数据时时间戳为-1，且不标记为新消息</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">let</span> m = <span class="type">Msg</span>(<span class="type">SMSCategory</span>.<span class="type">SMS</span>.rawValue,<span class="string">"\(content)"</span>,<span class="string">"\(code)"</span>,<span class="string">"\(vendor)"</span>,<span class="string">"\(phone_num)"</span>,date_time_stamp!,is_new_msg)</span><br><span class="line">                    msg.append(m)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 进行回调</span></span><br><span class="line">                completionHandler(msg,<span class="literal">true</span>,<span class="string">""</span>,<span class="number">200</span>)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">let</span> errorCode=response.error!._code</span><br><span class="line">                <span class="keyword">var</span> tipText=<span class="string">"刷新失败"</span></span><br><span class="line">                <span class="keyword">switch</span> (response.error!._code)&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="type">NSURLErrorTimedOut</span>:</span><br><span class="line">                    tipText=<span class="string">"网络超时"</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">case</span> <span class="type">NSURLErrorNotConnectedToInternet</span>:</span><br><span class="line">                    tipText=<span class="string">"网络未连接"</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">case</span> <span class="type">NSURLErrorNetworkConnectionLost</span>:</span><br><span class="line">                    tipText=<span class="string">"网络连接失去"</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">case</span> <span class="type">NSURLErrorBadURL</span>:</span><br><span class="line">                    tipText=<span class="string">"URL错误"</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">case</span> <span class="type">NSURLErrorCannotConnectToHost</span>:</span><br><span class="line">                    tipText=<span class="string">"无法连接主机"</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">53</span>:</span><br><span class="line">                    tipText=<span class="string">"刷新失败"</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    tipText=<span class="string">"刷新失败"</span></span><br><span class="line">                &#125;</span><br><span class="line">                completionHandler(msg,<span class="literal">false</span>,tipText,errorCode)</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果超时8秒，将这个请求取消</span></span><br><span class="line">    <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: <span class="type">DispatchTime</span>.now()+<span class="number">8</span>) &#123;</span><br><span class="line">        manager.session.getAllTasks &#123; (tasks) <span class="keyword">in</span></span><br><span class="line">            tasks.forEach(&#123; (task) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">if</span>(task.originalRequest?.url?.absoluteString == url)&#123;</span><br><span class="line">                    task.cancel()</span><br><span class="line">                    completionHandler(msg,<span class="literal">false</span>,<span class="string">"网络超时主动关闭"</span>, <span class="type">NSURLErrorTimedOut</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取电量信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetchBatteryInfo</span><span class="params">(completionHandler: @escaping <span class="params">(<span class="number">_</span> success:Bool,<span class="number">_</span> errorReason:String)</span></span></span> -&gt; () )&#123;</span><br><span class="line">    <span class="keyword">let</span> manager = <span class="type">Alamofire</span>.<span class="type">SessionManager</span>.<span class="keyword">default</span></span><br><span class="line">    <span class="comment">// 因为需要发邮件所以延迟时间设为10秒</span></span><br><span class="line">    manager.session.configuration.timeoutIntervalForRequest = <span class="type">TimeInterval</span>(<span class="number">10</span>)</span><br><span class="line">    manager.session.configuration.timeoutIntervalForRequest = <span class="type">TimeInterval</span>(<span class="number">10</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 给请求的URL添加随机冗余参数，方便超时取消</span></span><br><span class="line">    <span class="keyword">let</span> url = <span class="type">BASE_URL</span>+<span class="type">GET_BATTERY_PATH</span>+<span class="string">"?id="</span>+<span class="type">String</span>(<span class="type">Int</span>(arc4random()%<span class="number">100000</span>)+<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    manager.request(url, method: .<span class="keyword">get</span>, encoding: <span class="type">JSONEncoding</span>.<span class="keyword">default</span>)</span><br><span class="line">        .responseJSON &#123; response <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> value = response.result.value &#123;</span><br><span class="line">                <span class="keyword">let</span> json = <span class="type">JSON</span>(value)</span><br><span class="line">                <span class="keyword">let</span> rsp = <span class="type">Int</span>(<span class="type">String</span>(describing: json[<span class="string">"rsp"</span>]))</span><br><span class="line">                <span class="keyword">let</span> msg:<span class="type">String</span> = <span class="type">String</span>(describing: json[<span class="string">"msg"</span>])</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span>(rsp==<span class="number">200</span>)&#123;</span><br><span class="line">                    completionHandler(<span class="literal">true</span>,msg)</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span> (rsp == <span class="number">400</span>) &#123;</span><br><span class="line">                    completionHandler(<span class="literal">false</span>,msg)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> data = response.data, <span class="keyword">let</span> utf8Text = <span class="type">String</span>(data: data, encoding: .utf8) &#123;</span><br><span class="line">                <span class="comment">// 服务器关闭或者超时</span></span><br><span class="line">                <span class="keyword">if</span>(utf8Text==<span class="string">""</span> || !response.result.isSuccess)&#123;</span><br><span class="line">                    completionHandler(<span class="literal">false</span>,<span class="string">"请求失败!"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果超时10秒，将这个请求取消</span></span><br><span class="line">    <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: <span class="type">DispatchTime</span>.now()+<span class="number">10</span>) &#123;</span><br><span class="line">        manager.session.getAllTasks &#123; (tasks) <span class="keyword">in</span></span><br><span class="line">            tasks.forEach(&#123; (task) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">if</span>(task.originalRequest?.url?.absoluteString == url)&#123;</span><br><span class="line">                    task.cancel()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换时间戳为可读时间</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">convertTimeStamp2FormatDate</span><span class="params">(timestamp:Int,fomart : String? = <span class="literal">nil</span> )</span></span> -&gt; <span class="type">String</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> dateFormartString=fomart ?? <span class="string">"MM月dd日 HH:mm"</span></span><br><span class="line">    <span class="keyword">let</span> date = <span class="type">Date</span>(timeIntervalSince1970: <span class="type">TimeInterval</span>(timestamp))</span><br><span class="line">    <span class="keyword">let</span> dateFormatter = <span class="type">DateFormatter</span>()</span><br><span class="line">    dateFormatter.timeZone = <span class="type">TimeZone</span>(abbreviation: <span class="string">"GMT+8"</span>) <span class="comment">//Set timezone that you want</span></span><br><span class="line">    dateFormatter.locale = <span class="type">NSLocale</span>.current</span><br><span class="line">    dateFormatter.dateFormat = dateFormartString  <span class="comment">//Specify your format that you want</span></span><br><span class="line">    <span class="keyword">let</span> strDate = dateFormatter.string(from: date)</span><br><span class="line">    <span class="keyword">return</span> strDate</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">showToast</span><span class="params">(message : String)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> toastLabel = <span class="type">UILabel</span>(frame: <span class="type">CGRect</span>(x: <span class="keyword">self</span>.view.frame.size.width/<span class="number">2</span> - <span class="number">150</span>,</span><br><span class="line">                                               y: <span class="keyword">self</span>.view.frame.size.height-<span class="number">150</span>, width: <span class="number">300</span>, height: <span class="number">35</span>))</span><br><span class="line">        toastLabel.backgroundColor = <span class="type">UIColor</span>.black.withAlphaComponent(<span class="number">0.6</span>)</span><br><span class="line">        toastLabel.textColor = <span class="type">UIColor</span>.white</span><br><span class="line">        toastLabel.textAlignment = .center;</span><br><span class="line">        toastLabel.font = <span class="type">UIFont</span>(name: <span class="string">"Montserrat-Light"</span>, size: <span class="number">12.0</span>)</span><br><span class="line">        toastLabel.text = message</span><br><span class="line">        toastLabel.alpha = <span class="number">1.0</span></span><br><span class="line">        toastLabel.layer.cornerRadius = <span class="number">10</span>;</span><br><span class="line">        toastLabel.clipsToBounds  =  <span class="literal">true</span></span><br><span class="line">        <span class="keyword">self</span>.view.addSubview(toastLabel)</span><br><span class="line">        <span class="type">UIView</span>.animate(withDuration: <span class="number">4.0</span>, delay: <span class="number">0.1</span>, options: .curveEaseOut, animations: &#123;</span><br><span class="line">            toastLabel.alpha = <span class="number">0.0</span></span><br><span class="line">        &#125;, completion: &#123;(isCompleted) <span class="keyword">in</span></span><br><span class="line">            toastLabel.removeFromSuperview()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向数据库存储短信列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveMsg2CoreData</span><span class="params">(msg:Msg,category:String=SMSCategory.FAV.rawValue)</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取管理的数据上下文 对象</span></span><br><span class="line">    <span class="keyword">let</span> app = <span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span></span><br><span class="line">    <span class="keyword">let</span> context = app.persistentContainer.viewContext</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建User对象</span></span><br><span class="line">    <span class="keyword">let</span> mMsgData = <span class="type">NSEntityDescription</span>.insertNewObject(forEntityName: <span class="string">"MsgData"</span>,</span><br><span class="line">                                                       into: context) <span class="keyword">as</span>! <span class="type">MsgData</span></span><br><span class="line">    mMsgData.category=category</span><br><span class="line">    mMsgData.content = msg.content</span><br><span class="line">    mMsgData.code = msg.code</span><br><span class="line">    mMsgData.vendor = msg.vendor</span><br><span class="line">    mMsgData.phone_num = msg.phone_num</span><br><span class="line">    mMsgData.date_time = <span class="type">Int32</span>(msg.date_time)</span><br><span class="line">    mMsgData.is_new_msg=msg.is_new_msg</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//保存</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> context.save()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"保存成功！"</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"不能保存：\(error)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从数据库读取短信列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetchMsgFromCoreData</span><span class="params">(category:String)</span></span> -&gt; [<span class="type">Msg</span>]&#123;</span><br><span class="line">    <span class="keyword">var</span> msg = [<span class="type">Msg</span>]()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取管理的数据上下文 对象</span></span><br><span class="line">    <span class="keyword">let</span> app = <span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span></span><br><span class="line">    <span class="keyword">let</span> context = app.persistentContainer.viewContext</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//声明数据的请求</span></span><br><span class="line">    <span class="keyword">let</span> fetchRequest = <span class="type">NSFetchRequest</span>&lt;<span class="type">MsgData</span>&gt;(entityName:<span class="string">"MsgData"</span>)</span><br><span class="line">    fetchRequest.fetchLimit = <span class="number">10000</span> <span class="comment">//限定查询结果的数量</span></span><br><span class="line">    fetchRequest.fetchOffset = <span class="number">0</span> <span class="comment">//查询的偏移量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置查询条件</span></span><br><span class="line">    <span class="keyword">let</span> predicate = <span class="type">NSPredicate</span>(format: <span class="string">"category = '"</span>+category+<span class="string">"' "</span>, <span class="string">""</span>)</span><br><span class="line">    fetchRequest.predicate = predicate</span><br><span class="line">    <span class="comment">//查询操作</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fetchedObjects = <span class="keyword">try</span> context.fetch(fetchRequest)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//遍历查询的结果</span></span><br><span class="line">        <span class="keyword">for</span> info <span class="keyword">in</span> fetchedObjects &#123;</span><br><span class="line">            msg.append(<span class="type">Msg</span>(info.category!,info.content!,info.code!,info.vendor!,</span><br><span class="line">                           info.phone_num!,<span class="type">Int</span>(info.date_time),info.is_new_msg))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> msg</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"不能读取：\(error)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从数据库指定项目</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deleteItem</span><span class="params">(date_time:Int)</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取管理的数据上下文 对象</span></span><br><span class="line">    <span class="keyword">let</span> app = <span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span></span><br><span class="line">    <span class="keyword">let</span> context = app.persistentContainer.viewContext</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//声明数据的请求</span></span><br><span class="line">    <span class="keyword">let</span> fetchRequest = <span class="type">NSFetchRequest</span>&lt;<span class="type">MsgData</span>&gt;(entityName:<span class="string">"MsgData"</span>)</span><br><span class="line">    fetchRequest.fetchLimit = <span class="number">10000</span> <span class="comment">//限定查询结果的数量</span></span><br><span class="line">    fetchRequest.fetchOffset = <span class="number">0</span> <span class="comment">//查询的偏移量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置查询条件</span></span><br><span class="line">    <span class="keyword">let</span> predicate = <span class="type">NSPredicate</span>(format: <span class="string">"date_time = \(date_time) "</span>, <span class="string">""</span>)</span><br><span class="line">    fetchRequest.predicate = predicate</span><br><span class="line">    <span class="comment">//查询操作</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fetchedObjects = <span class="keyword">try</span> context.fetch(fetchRequest)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//遍历查询的结果</span></span><br><span class="line">        <span class="keyword">for</span> info <span class="keyword">in</span> fetchedObjects &#123;</span><br><span class="line">            context.delete(info)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>! context.save()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"不能删除：\(error)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从数据库删除所有收藏信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deleteAll</span><span class="params">(category:String = SMSCategory.FAV.rawValue)</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取管理的数据上下文 对象</span></span><br><span class="line">    <span class="keyword">let</span> app = <span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span></span><br><span class="line">    <span class="keyword">let</span> context = app.persistentContainer.viewContext</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//声明数据的请求</span></span><br><span class="line">    <span class="keyword">let</span> fetchRequest = <span class="type">NSFetchRequest</span>&lt;<span class="type">MsgData</span>&gt;(entityName:<span class="string">"MsgData"</span>)</span><br><span class="line">    fetchRequest.fetchLimit = <span class="number">10000</span> <span class="comment">//限定查询结果的数量</span></span><br><span class="line">    fetchRequest.fetchOffset = <span class="number">0</span> <span class="comment">//查询的偏移量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置查询条件</span></span><br><span class="line">    <span class="keyword">let</span> predicate = <span class="type">NSPredicate</span>(format: <span class="string">"category = '"</span>+category+<span class="string">"' "</span>, <span class="string">""</span>)</span><br><span class="line">    fetchRequest.predicate = predicate</span><br><span class="line">    <span class="comment">//查询操作</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fetchedObjects = <span class="keyword">try</span> context.fetch(fetchRequest)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//遍历查询的结果</span></span><br><span class="line">        <span class="keyword">for</span> info <span class="keyword">in</span> fetchedObjects &#123;</span><br><span class="line">            context.delete(info)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>! context.save()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"不能删除：\(error)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 向数据库存储服务器信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveServerInfo</span><span class="params">(host:String=BASE_HOST,port:String=BASE_PORT,path:String=BASE_PATH,</span></span></span><br><span class="line"><span class="function"><span class="params">                    push_alias:String=PUSH_ALIAS,aes_key:String=AES_KEY)</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取管理的数据上下文 对象</span></span><br><span class="line">    <span class="keyword">let</span> app = <span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span></span><br><span class="line">    <span class="keyword">let</span> context = app.persistentContainer.viewContext</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建User对象</span></span><br><span class="line">    <span class="keyword">let</span> mServerData = <span class="type">NSEntityDescription</span>.insertNewObject(forEntityName: <span class="string">"ServerData"</span>,</span><br><span class="line">                                                          into: context) <span class="keyword">as</span>! <span class="type">ServerData</span></span><br><span class="line">    mServerData.host = host</span><br><span class="line">    mServerData.port = port</span><br><span class="line">    mServerData.path = path</span><br><span class="line">    mServerData.push_alias = push_alias</span><br><span class="line">    mServerData.aes_key = aes_key</span><br><span class="line">    mServerData.date = <span class="type">Int32</span>(<span class="type">NSDate</span>().timeIntervalSince1970)</span><br><span class="line">    <span class="comment">//保存</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> context.save()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"保存成功！"</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"不能保存：\(error)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从数据库读取服务器信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">querytServerInfo</span><span class="params">()</span></span> -&gt; (<span class="type">String</span>,<span class="type">String</span>,<span class="type">String</span>,<span class="type">String</span>,<span class="type">String</span>) &#123;</span><br><span class="line">    <span class="comment">//获取管理的数据上下文 对象</span></span><br><span class="line">    <span class="keyword">let</span> app = <span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span></span><br><span class="line">    <span class="keyword">let</span> context = app.persistentContainer.viewContext</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//声明数据的请求</span></span><br><span class="line">    <span class="keyword">let</span> fetchRequest = <span class="type">NSFetchRequest</span>&lt;<span class="type">ServerData</span>&gt;(entityName:<span class="string">"ServerData"</span>)</span><br><span class="line">    fetchRequest.fetchLimit = <span class="number">1</span> <span class="comment">//限定查询结果的数量</span></span><br><span class="line">    fetchRequest.fetchOffset = <span class="number">0</span> <span class="comment">//查询的偏移量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 只查询最新一条数据，日期降序排列</span></span><br><span class="line">    <span class="keyword">let</span> sortDescriptor = <span class="type">NSSortDescriptor</span>(key: <span class="string">"date"</span>, ascending: <span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">let</span> sortDescriptors = [sortDescriptor]</span><br><span class="line">    fetchRequest.sortDescriptors = sortDescriptors</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//查询操作</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fetchedObjects = <span class="keyword">try</span> context.fetch(fetchRequest)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(fetchedObjects.<span class="built_in">count</span>==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//            return ("http://192.168.2.33","58585","/645atU3453463duWNu455469fJGZ","888","888")</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="string">"https://m.xxx666.ml"</span>,<span class="string">"58585"</span>,<span class="string">"/645atU3453463duWNu455469fJGZ"</span>,<span class="string">"888"</span>,<span class="string">"888"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> host=fetchedObjects[<span class="number">0</span>].host</span><br><span class="line">        <span class="keyword">let</span> port=fetchedObjects[<span class="number">0</span>].port</span><br><span class="line">        <span class="keyword">let</span> path=fetchedObjects[<span class="number">0</span>].path</span><br><span class="line">        <span class="keyword">let</span> push_alias=fetchedObjects[<span class="number">0</span>].push_alias</span><br><span class="line">        <span class="keyword">let</span> aes_key=fetchedObjects[<span class="number">0</span>].aes_key</span><br><span class="line">        <span class="keyword">return</span> (host!,port!,path!,push_alias!,aes_key!)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"不能读取：\(error)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//    return ("http://192.168.2.33","58585","/645atU3453463duWNu455469fJGZ","888","888")</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="string">"https://m.xxx666.ml"</span>,<span class="string">"58585"</span>,<span class="string">"/645atU3453463duWNu455469fJGZ"</span>,<span class="string">"888"</span>,<span class="string">"888"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从数据库删除服务器信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deleteAllServerInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//获取管理的数据上下文 对象</span></span><br><span class="line">    <span class="keyword">let</span> app = <span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span></span><br><span class="line">    <span class="keyword">let</span> context = app.persistentContainer.viewContext</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//声明数据的请求</span></span><br><span class="line">    <span class="keyword">let</span> fetchRequest = <span class="type">NSFetchRequest</span>&lt;<span class="type">ServerData</span>&gt;(entityName:<span class="string">"ServerData"</span>)</span><br><span class="line">    fetchRequest.fetchLimit = <span class="number">10000</span> <span class="comment">//限定查询结果的数量</span></span><br><span class="line">    fetchRequest.fetchOffset = <span class="number">0</span> <span class="comment">//查询的偏移量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//查询操作</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> fetchedObjects = <span class="keyword">try</span> context.fetch(fetchRequest)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//遍历查询的结果</span></span><br><span class="line">        <span class="keyword">for</span> info <span class="keyword">in</span> fetchedObjects &#123;</span><br><span class="line">            context.delete(info)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>! context.save()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"不能删除：\(error)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/开发/">开发</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/06/11/使用Fiddle+Postman实现微信刷票小记/" data-tooltip="使用Fiddle+Postman实现微信刷票小记" aria-label="PREVIOUS: 使用Fiddle+Postman实现微信刷票小记">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/05/24/旧手机短信转发的解决方案（三）服务器端/" data-tooltip="旧手机短信转发的解决方案（三）服务器端" aria-label="NEXT: 旧手机短信转发的解决方案（三）服务器端">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/" title="Share on Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/" title="Share on Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/" title="Share on Weibo">
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/&amp;title=旧手机短信转发的解决方案（四）iOS端" title="Share on QQ">
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>





                

                
                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
		Copyrights &copy; 2020 AndrewWang. All Rights Reserved.
    </span>
</footer>

                

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/06/11/使用Fiddle+Postman实现微信刷票小记/" data-tooltip="使用Fiddle+Postman实现微信刷票小记" aria-label="PREVIOUS: 使用Fiddle+Postman实现微信刷票小记">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/05/24/旧手机短信转发的解决方案（三）服务器端/" data-tooltip="旧手机短信转发的解决方案（三）服务器端" aria-label="NEXT: 旧手机短信转发的解决方案（三）服务器端">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/" title="Share on Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/" title="Share on Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/" title="Share on Weibo">
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/&amp;title=旧手机短信转发的解决方案（四）iOS端" title="Share on QQ">
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="2">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/">
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/">
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/">
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>Share on Weibo</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://xiaoo.ml/2017/05/27/旧手机短信转发的解决方案（四）iOS端/&amp;title=旧手机短信转发的解决方案（四）iOS端">
                        <i class="fab fa-qq" aria-hidden="true"></i><span>Share on QQ</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/avatar(7).png" alt="Author&#39;s picture">
        
            <h4 id="about-card-name">AndrewWang</h4>
        
            <div id="about-card-bio"><p>凡是过去，皆为序章<br>须知参差百态，乃是幸福本源<br>邮箱：<a href="mailto:fernando_caudill@outlook.com" target="_blank">fernando_caudill@outlook.com</a></p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>Android+Python</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br>
                Zhangzhou Fujian
            </div>
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-times"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/others/algolia-light.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search" class="form-control input--large search-input" placeholder="Search ">
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">no post found</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://xiaoo.ml/2013/01/22/Cloneable和clone的使用，以及深复制与浅复制的区别/">
                            <h3 class="media-heading">Cloneable和clone的使用，以及深复制与浅复制的区别</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 22, 2013
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><ni>深浅复制总结下</ni></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://xiaoo.ml/2013/02/04/Ubuntu Problem/">
                            <h3 class="media-heading">Ubuntu Problem</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Feb 4, 2013
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><ni>记录最近几年使用Ubuntu有用的Tips</ni></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://xiaoo.ml/2013/08/18/婚后，你一定会遇到更喜欢的人/">
                            <h3 class="media-heading">婚后，你一定会遇到更喜欢的人</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Aug 18, 2013
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>结婚后，你一定会遇到更喜欢的人。这件事几乎是肯定的。倒不是说先前结婚的人有多糟糕，也不是说后来出现的人有多美好。而是，你更了解自己了。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://xiaoo.ml/2013/11/09/ImageLoader must be init with configuration before using 错误解决方法/">
                            <h3 class="media-heading">ImageLoader must be init with configuration before using 错误解决方法</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Nov 9, 2013
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>最近开发过程中用到了开源项目Android-Universal-Image-Loader。<br></p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://xiaoo.ml/2013/12/14/把WordPress放在根目录而地址显示子目录的方法/">
                            <h3 class="media-heading">把WordPress放在根目录而地址显示子目录的方法</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Dec 14, 2013
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p> 今天在狗爹（GoDaddy）随便买了个域名，想建个个人博客耍耍。<br></p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://xiaoo.ml/2014/02/15/越是聪明人，越容易在这件事上栽跟头/">
                            <h3 class="media-heading">越是聪明人，越容易在这件事上栽跟头zt</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Feb 15, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>一篇名为《李开复：聪明人创业为何容易失败》的商业报道里写道，记者问李开复，如何在短时间内对一个创业者或项目进行判断，有哪些指标或者投资方法论？<br></p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://xiaoo.ml/2014/04/02/Java中普通代码块，构造代码块，静态代码块区别及代码示例/">
                            <h3 class="media-heading">Java中普通代码块，构造代码块，静态代码块区别及代码示例</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 2, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>执行顺序：（优先级从高到低）静态代码块&gt;main方法&gt;构造代码块&gt;构造方法。其中静态代码块只执行一次。构造代码块在每次创建对象是都会执行。<br></p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://xiaoo.ml/2014/04/14/getApplicationContext()、getBasecontext()、getApplication() 区别/">
                            <h3 class="media-heading">getApplicationContext()、getBasecontext()、getApplication() 区别</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 14, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><ni>搞清区别联系很重要，虽然好多情况下能通用的。</ni></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://xiaoo.ml/2014/04/24/使用注解来统计算法时间/">
                            <h3 class="media-heading">使用注解统计算法运行时间</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 24, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>一直以为注解并没有什么卵用，后来用了butterknift和spring组件后才知道自定义组件可以完成很多任务。<br></p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://xiaoo.ml/2014/05/22/git merge和rebase的区别/">
                            <h3 class="media-heading">git merge和rebase的区别</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    May 22, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><ni>一直以来都以为rebase是合并冲突的一种手段，和merge一样的，用哪个都行。</ni></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium" data-message-zero="no post found" data-message-one="1 post found" data-message-other="{n} posts found">
                80 posts found
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/js/script-dbd16rvloemmuxdzniplmnxxvwoz24eya9wol0b7vvmlokgqsjivmb8dnscy.min.js"></script>
<!--SCRIPTS END-->

    


    <script src="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/js/moment-with-locales.min.js"></script>
    <script src="https://my-blog-hexo-1253240671.cos.ap-shanghai.myqcloud.com/js/algoliasearch.min.js"></script>
    <script>
        var algoliaClient = algoliasearch('NPCJXUJXHV', '519d0ecd5f05b733ac031d89154c7bbb');
        var algoliaIndex = algoliaClient.initIndex('my-hexo-blog');
    </script>


    </body>
</html>
